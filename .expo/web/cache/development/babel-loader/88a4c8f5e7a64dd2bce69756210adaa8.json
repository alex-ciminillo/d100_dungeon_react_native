{"ast":null,"code":"import $ from 'jquery';\nimport { useEffect } from 'react';\nimport { jsx as _jsx } from \"react/jsx-runtime\";\nimport { jsxs as _jsxs } from \"react/jsx-runtime\";\nexport default function DiceReact() {\n  window.teal = {};\n  window.$t = window.teal;\n\n  teal.copyto = function (obj, res) {\n    if (obj == null || typeof obj !== 'object') return obj;\n\n    if (obj instanceof Array) {\n      for (var i = obj.length - 1; i >= 0; --i) {\n        res[i] = $t.copy(obj[i]);\n      }\n    } else {\n      for (var i in obj) {\n        if (obj.hasOwnProperty(i)) res[i] = $t.copy(obj[i]);\n      }\n    }\n\n    return res;\n  };\n\n  teal.copy = function (obj) {\n    if (!obj) return obj;\n    return teal.copyto(obj, new obj.constructor());\n  };\n\n  teal.element = function (name, props, place, content) {\n    var dom = document.createElement(name);\n    if (props) for (var i in props) {\n      dom.setAttribute(i, props[i]);\n    }\n    if (place) place.appendChild(dom);\n    if (content !== undefined) $t.inner(content, dom);\n    return dom;\n  };\n\n  teal.inner = function (obj, sel) {\n    sel.appendChild(obj.nodeName != undefined ? obj : document.createTextNode(obj));\n    return sel;\n  };\n\n  teal.id = function (id) {\n    return document.getElementById(id);\n  };\n\n  teal.set = function (sel, props) {\n    for (var i in props) {\n      sel.setAttribute(i, props[i]);\n    }\n\n    return sel;\n  };\n\n  teal.clas = function (sel, oldclass, newclass) {\n    var oc = oldclass ? oldclass.split(/\\s+/) : [],\n        nc = newclass ? newclass.split(/\\s+/) : [],\n        classes = (sel.getAttribute('class') || '').split(/\\s+/);\n    if (!classes[0]) classes = [];\n\n    for (var i in oc) {\n      var ind = classes.indexOf(oc[i]);\n      if (ind >= 0) classes.splice(ind, 1);\n    }\n\n    for (var i in nc) {\n      if (nc[i] && classes.indexOf(nc[i]) < 0) classes.push(nc[i]);\n    }\n\n    sel.setAttribute('class', classes.join(' '));\n  };\n\n  teal.empty = function (sel) {\n    if (sel.childNodes) while (sel.childNodes.length) {\n      sel.removeChild(sel.firstChild);\n    }\n  };\n\n  teal.remove = function (sel) {\n    if (sel) {\n      if (sel.parentNode) sel.parentNode.removeChild(sel);else for (var i = sel.length - 1; i >= 0; --i) {\n        sel[i].parentNode.removeChild(sel[i]);\n      }\n    }\n  };\n\n  teal.bind = function (sel, eventname, func, bubble) {\n    if (!sel) return;\n\n    if (eventname.constructor === Array) {\n      for (var i in eventname) {\n        sel.addEventListener(eventname[i], func, bubble ? bubble : false);\n      }\n    } else sel.addEventListener(eventname, func, bubble ? bubble : false);\n  };\n\n  teal.unbind = function (sel, eventname, func, bubble) {\n    if (eventname.constructor === Array) {\n      for (var i in eventname) {\n        sel.removeEventListener(eventname[i], func, bubble ? bubble : false);\n      }\n    } else sel.removeEventListener(eventname, func, bubble ? bubble : false);\n  };\n\n  teal.one = function (sel, eventname, func, bubble) {\n    var one_func = function one_func(e) {\n      func.call(this, e);\n      teal.unbind(sel, eventname, one_func, bubble);\n    };\n\n    teal.bind(sel, eventname, one_func, bubble);\n  };\n\n  teal.raise_event = function (sel, eventname, bubble, cancelable) {\n    var evt = document.createEvent('UIEvents');\n    evt.initEvent(eventname, bubble == undefined ? true : bubble, cancelable == undefined ? true : cancelable);\n    sel.dispatchEvent(evt);\n  };\n\n  teal.raise = function (sel, eventname, params, bubble, cancelable) {\n    var ev = document.createEvent(\"CustomEvent\");\n    ev.initCustomEvent(eventname, bubble, cancelable, params);\n    sel.dispatchEvent(ev);\n  };\n\n  if (!document.getElementsByClassName) {\n    teal.get_elements_by_class = function (classes, node) {\n      var node = node || document,\n          list = node.getElementsByTagName('*'),\n          cl = classes.split(/\\s+/),\n          result = [];\n\n      for (var i = list.length - 1; i >= 0; --i) {\n        for (var j = cl.length - 1; j >= 0; --j) {\n          var clas = list[i].getAttribute('class');\n\n          if (clas && clas.search('\\\\b' + cl[j] + '\\\\b') != -1) {\n            result.push(list[i]);\n            break;\n          }\n        }\n      }\n\n      return result;\n    };\n  } else {\n    teal.get_elements_by_class = function (classes, node) {\n      return (node || document).getElementsByClassName(classes);\n    };\n  }\n\n  teal.rpc = function (params, callback, noparse) {\n    var ajax = new XMLHttpRequest();\n    ajax.open(\"post\", 'f', true);\n\n    ajax.onreadystatechange = function () {\n      if (ajax.readyState == 4) callback.call(ajax, noparse ? ajax.responseText : JSON.parse(ajax.responseText));\n    };\n\n    ajax.send(JSON.stringify(params));\n  };\n\n  teal.uuid = function () {\n    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\n      var r = Math.random() * 16 | 0,\n          v = c == 'x' ? r : r & 0x3 | 0x8;\n      return v.toString(16);\n    });\n  };\n\n  teal.get_url_params = function () {\n    var params = window.location.search.substring(1).split(\"&\");\n    var res = {};\n\n    for (var i in params) {\n      var keyvalue = params[i].split(\"=\");\n      res[keyvalue[0]] = decodeURI(keyvalue[1]);\n    }\n\n    return res;\n  };\n\n  teal.get_mouse_coords = function (ev) {\n    var touches = ev.changedTouches;\n    if (touches) return {\n      x: touches[0].clientX,\n      y: touches[0].clientY\n    };\n    return {\n      x: ev.clientX,\n      y: ev.clientY\n    };\n  };\n\n  teal.deferred = function () {\n    var solved = false,\n        callbacks = [],\n        args = [];\n\n    function solve() {\n      while (callbacks.length) {\n        callbacks.shift().apply(this, args);\n      }\n    }\n\n    return {\n      promise: function promise() {\n        return {\n          then: function then(callback) {\n            var deferred = teal.deferred(),\n                promise = deferred.promise();\n            callbacks.push(function () {\n              var res = callback.apply(this, arguments);\n              if (res && 'done' in res) res.done(deferred.resolve);else deferred.resolve.apply(this, arguments);\n            });\n            return promise;\n          },\n          done: function done(callback) {\n            callbacks.push(callback);\n            if (solved) solve();\n            return this;\n          },\n          cancel: function cancel() {\n            callbacks = [];\n          }\n        };\n      },\n      resolve: function resolve() {\n        solved = true;\n        args = Array.prototype.slice.call(arguments, 0);\n        solve();\n      }\n    };\n  };\n\n  teal.when = function (promises) {\n    var deferred = teal.deferred();\n    var count = promises.length,\n        ind = 0;\n    if (count == 0) deferred.resolve();\n\n    for (var i = 0; i < count; ++i) {\n      promises[i].done(function () {\n        if (++ind == count) deferred.resolve();\n      });\n    }\n\n    return deferred.promise();\n  };\n\n  var random_storage = [];\n  var use_true_random = true;\n  var frame_rate = 1 / 60;\n\n  function prepare_rnd(callback) {\n    if (!random_storage.length && $t.dice.use_true_random) {\n      try {\n        $t.rpc({\n          method: \"random\",\n          n: 512\n        }, function (random_responce) {\n          if (!random_responce.error) random_storage = random_responce.result.random.data;else $t.dice.use_true_random = false;\n          callback();\n        });\n        return;\n      } catch (e) {\n        $t.dice.use_true_random = false;\n      }\n    }\n\n    callback();\n  }\n\n  function rnd() {\n    return random_storage.length ? random_storage.pop() : Math.random();\n  }\n\n  function create_shape(vertices, faces, radius) {\n    var cv = new Array(vertices.length),\n        cf = new Array(faces.length);\n\n    for (var i = 0; i < vertices.length; ++i) {\n      var v = vertices[i];\n      cv[i] = new CANNON.Vec3(v.x * radius, v.y * radius, v.z * radius);\n    }\n\n    for (var i = 0; i < faces.length; ++i) {\n      cf[i] = faces[i].slice(0, faces[i].length - 1);\n    }\n\n    return new CANNON.ConvexPolyhedron(cv, cf);\n  }\n\n  function make_geom(vertices, faces, radius, tab, af) {\n    var geom = new THREE.Geometry();\n\n    for (var i = 0; i < vertices.length; ++i) {\n      var vertex = vertices[i].multiplyScalar(radius);\n      vertex.index = geom.vertices.push(vertex) - 1;\n    }\n\n    for (var i = 0; i < faces.length; ++i) {\n      var ii = faces[i],\n          fl = ii.length - 1;\n      var aa = Math.PI * 2 / fl;\n\n      for (var j = 0; j < fl - 2; ++j) {\n        geom.faces.push(new THREE.Face3(ii[0], ii[j + 1], ii[j + 2], [geom.vertices[ii[0]], geom.vertices[ii[j + 1]], geom.vertices[ii[j + 2]]], 0, ii[fl] + 1));\n        geom.faceVertexUvs[0].push([new THREE.Vector2((Math.cos(af) + 1 + tab) / 2 / (1 + tab), (Math.sin(af) + 1 + tab) / 2 / (1 + tab)), new THREE.Vector2((Math.cos(aa * (j + 1) + af) + 1 + tab) / 2 / (1 + tab), (Math.sin(aa * (j + 1) + af) + 1 + tab) / 2 / (1 + tab)), new THREE.Vector2((Math.cos(aa * (j + 2) + af) + 1 + tab) / 2 / (1 + tab), (Math.sin(aa * (j + 2) + af) + 1 + tab) / 2 / (1 + tab))]);\n      }\n    }\n\n    geom.computeFaceNormals();\n    geom.boundingSphere = new THREE.Sphere(new THREE.Vector3(), radius);\n    return geom;\n  }\n\n  function chamfer_geom(vectors, faces, chamfer) {\n    var chamfer_vectors = [],\n        chamfer_faces = [],\n        corner_faces = new Array(vectors.length);\n\n    for (var i = 0; i < vectors.length; ++i) {\n      corner_faces[i] = [];\n    }\n\n    for (var i = 0; i < faces.length; ++i) {\n      var ii = faces[i],\n          fl = ii.length - 1;\n      var center_point = new THREE.Vector3();\n      var face = new Array(fl);\n\n      for (var j = 0; j < fl; ++j) {\n        var vv = vectors[ii[j]].clone();\n        center_point.add(vv);\n        corner_faces[ii[j]].push(face[j] = chamfer_vectors.push(vv) - 1);\n      }\n\n      center_point.divideScalar(fl);\n\n      for (var j = 0; j < fl; ++j) {\n        var vv = chamfer_vectors[face[j]];\n        vv.subVectors(vv, center_point).multiplyScalar(chamfer).addVectors(vv, center_point);\n      }\n\n      face.push(ii[fl]);\n      chamfer_faces.push(face);\n    }\n\n    for (var i = 0; i < faces.length - 1; ++i) {\n      for (var j = i + 1; j < faces.length; ++j) {\n        var pairs = [],\n            lastm = -1;\n\n        for (var m = 0; m < faces[i].length - 1; ++m) {\n          var n = faces[j].indexOf(faces[i][m]);\n\n          if (n >= 0 && n < faces[j].length - 1) {\n            if (lastm >= 0 && m != lastm + 1) pairs.unshift([i, m], [j, n]);else pairs.push([i, m], [j, n]);\n            lastm = m;\n          }\n        }\n\n        if (pairs.length != 4) continue;\n        chamfer_faces.push([chamfer_faces[pairs[0][0]][pairs[0][1]], chamfer_faces[pairs[1][0]][pairs[1][1]], chamfer_faces[pairs[3][0]][pairs[3][1]], chamfer_faces[pairs[2][0]][pairs[2][1]], -1]);\n      }\n    }\n\n    for (var i = 0; i < corner_faces.length; ++i) {\n      var cf = corner_faces[i],\n          face = [cf[0]],\n          count = cf.length - 1;\n\n      while (count) {\n        for (var m = faces.length; m < chamfer_faces.length; ++m) {\n          var index = chamfer_faces[m].indexOf(face[face.length - 1]);\n\n          if (index >= 0 && index < 4) {\n            if (--index == -1) index = 3;\n            var next_vertex = chamfer_faces[m][index];\n\n            if (cf.indexOf(next_vertex) >= 0) {\n              face.push(next_vertex);\n              break;\n            }\n          }\n        }\n\n        --count;\n      }\n\n      face.push(-1);\n      chamfer_faces.push(face);\n    }\n\n    return {\n      vectors: chamfer_vectors,\n      faces: chamfer_faces\n    };\n  }\n\n  function create_geom(vertices, faces, radius, tab, af, chamfer) {\n    var vectors = new Array(vertices.length);\n\n    for (var i = 0; i < vertices.length; ++i) {\n      vectors[i] = new THREE.Vector3().fromArray(vertices[i]).normalize();\n    }\n\n    var cg = chamfer_geom(vectors, faces, chamfer);\n    var geom = make_geom(cg.vectors, cg.faces, radius, tab, af);\n    geom.cannon_shape = create_shape(vectors, faces, radius);\n    return geom;\n  }\n\n  var standart_d20_dice_face_labels = [' ', '0', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20'];\n  var standart_d100_dice_face_labels = [' ', '00', '10', '20', '30', '40', '50', '60', '70', '80', '90'];\n\n  function calc_texture_size(approx) {\n    return Math.pow(2, Math.floor(Math.log(approx) / Math.log(2)));\n  }\n\n  var create_dice_materials = function create_dice_materials(face_labels, size, margin) {\n    function create_text_texture(text, color, back_color) {\n      if (text == undefined) return null;\n      var canvas = document.createElement(\"canvas\");\n      var context = canvas.getContext(\"2d\");\n      var ts = calc_texture_size(size + size * 2 * margin) * 2;\n      canvas.width = canvas.height = ts;\n      context.font = ts / (1 + 2 * margin) + \"pt Arial\";\n      context.fillStyle = back_color;\n      context.fillRect(0, 0, canvas.width, canvas.height);\n      context.textAlign = \"center\";\n      context.textBaseline = \"middle\";\n      context.fillStyle = color;\n      context.fillText(text, canvas.width / 2, canvas.height / 2);\n\n      if (text == '6' || text == '9') {\n        context.fillText('  .', canvas.width / 2, canvas.height / 2);\n      }\n\n      var texture = new THREE.Texture(canvas);\n      texture.needsUpdate = true;\n      return texture;\n    }\n\n    var materials = [];\n\n    for (var i = 0; i < face_labels.length; ++i) {\n      materials.push(new THREE.MeshPhongMaterial($t.copyto(this.material_options, {\n        map: create_text_texture(face_labels[i], this.label_color, this.dice_color)\n      })));\n    }\n\n    return materials;\n  };\n\n  var d4_labels = [[[], [0, 0, 0], [2, 4, 3], [1, 3, 4], [2, 1, 4], [1, 2, 3]], [[], [0, 0, 0], [2, 3, 4], [3, 1, 4], [2, 4, 1], [3, 2, 1]], [[], [0, 0, 0], [4, 3, 2], [3, 4, 1], [4, 2, 1], [3, 1, 2]], [[], [0, 0, 0], [4, 2, 3], [1, 4, 3], [4, 1, 2], [1, 3, 2]]];\n\n  var create_d4_materials = function create_d4_materials(size, margin, labels) {\n    function create_d4_text(text, color, back_color) {\n      var canvas = document.createElement(\"canvas\");\n      var context = canvas.getContext(\"2d\");\n      var ts = calc_texture_size(size + margin) * 2;\n      canvas.width = canvas.height = ts;\n      context.font = (ts - margin) / 1.5 + \"pt Arial\";\n      context.fillStyle = back_color;\n      context.fillRect(0, 0, canvas.width, canvas.height);\n      context.textAlign = \"center\";\n      context.textBaseline = \"middle\";\n      context.fillStyle = color;\n\n      for (var i in text) {\n        context.fillText(text[i], canvas.width / 2, canvas.height / 2 - ts * 0.3);\n        context.translate(canvas.width / 2, canvas.height / 2);\n        context.rotate(Math.PI * 2 / 3);\n        context.translate(-canvas.width / 2, -canvas.height / 2);\n      }\n\n      var texture = new THREE.Texture(canvas);\n      texture.needsUpdate = true;\n      return texture;\n    }\n\n    var materials = [];\n\n    for (var i = 0; i < labels.length; ++i) {\n      materials.push(new THREE.MeshPhongMaterial($t.copyto(this.material_options, {\n        map: create_d4_text(labels[i], this.label_color, this.dice_color)\n      })));\n    }\n\n    return materials;\n  };\n\n  var create_d4_geometry = function create_d4_geometry(radius) {\n    var vertices = [[1, 1, 1], [-1, -1, 1], [-1, 1, -1], [1, -1, -1]];\n    var faces = [[1, 0, 2, 1], [0, 1, 3, 2], [0, 3, 2, 3], [1, 2, 3, 4]];\n    return create_geom(vertices, faces, radius, -0.1, Math.PI * 7 / 6, 0.96);\n  };\n\n  var create_d6_geometry = function create_d6_geometry(radius) {\n    var vertices = [[-1, -1, -1], [1, -1, -1], [1, 1, -1], [-1, 1, -1], [-1, -1, 1], [1, -1, 1], [1, 1, 1], [-1, 1, 1]];\n    var faces = [[0, 3, 2, 1, 1], [1, 2, 6, 5, 2], [0, 1, 5, 4, 3], [3, 7, 6, 2, 4], [0, 4, 7, 3, 5], [4, 5, 6, 7, 6]];\n    return create_geom(vertices, faces, radius, 0.1, Math.PI / 4, 0.96);\n  };\n\n  var create_d8_geometry = function create_d8_geometry(radius) {\n    var vertices = [[1, 0, 0], [-1, 0, 0], [0, 1, 0], [0, -1, 0], [0, 0, 1], [0, 0, -1]];\n    var faces = [[0, 2, 4, 1], [0, 4, 3, 2], [0, 3, 5, 3], [0, 5, 2, 4], [1, 3, 4, 5], [1, 4, 2, 6], [1, 2, 5, 7], [1, 5, 3, 8]];\n    return create_geom(vertices, faces, radius, 0, -Math.PI / 4 / 2, 0.965);\n  };\n\n  var create_d10_geometry = function create_d10_geometry(radius) {\n    var a = Math.PI * 2 / 10,\n        k = Math.cos(a),\n        h = 0.105,\n        v = -1;\n    var vertices = [];\n\n    for (var i = 0, b = 0; i < 10; ++i, b += a) {\n      vertices.push([Math.cos(b), Math.sin(b), h * (i % 2 ? 1 : -1)]);\n    }\n\n    vertices.push([0, 0, -1]);\n    vertices.push([0, 0, 1]);\n    var faces = [[5, 7, 11, 0], [4, 2, 10, 1], [1, 3, 11, 2], [0, 8, 10, 3], [7, 9, 11, 4], [8, 6, 10, 5], [9, 1, 11, 6], [2, 0, 10, 7], [3, 5, 11, 8], [6, 4, 10, 9], [1, 0, 2, v], [1, 2, 3, v], [3, 2, 4, v], [3, 4, 5, v], [5, 4, 6, v], [5, 6, 7, v], [7, 6, 8, v], [7, 8, 9, v], [9, 8, 0, v], [9, 0, 1, v]];\n    return create_geom(vertices, faces, radius, 0, Math.PI * 6 / 5, 0.945);\n  };\n\n  var create_d12_geometry = function create_d12_geometry(radius) {\n    var p = (1 + Math.sqrt(5)) / 2,\n        q = 1 / p;\n    var vertices = [[0, q, p], [0, q, -p], [0, -q, p], [0, -q, -p], [p, 0, q], [p, 0, -q], [-p, 0, q], [-p, 0, -q], [q, p, 0], [q, -p, 0], [-q, p, 0], [-q, -p, 0], [1, 1, 1], [1, 1, -1], [1, -1, 1], [1, -1, -1], [-1, 1, 1], [-1, 1, -1], [-1, -1, 1], [-1, -1, -1]];\n    var faces = [[2, 14, 4, 12, 0, 1], [15, 9, 11, 19, 3, 2], [16, 10, 17, 7, 6, 3], [6, 7, 19, 11, 18, 4], [6, 18, 2, 0, 16, 5], [18, 11, 9, 14, 2, 6], [1, 17, 10, 8, 13, 7], [1, 13, 5, 15, 3, 8], [13, 8, 12, 4, 5, 9], [5, 4, 14, 9, 15, 10], [0, 12, 8, 10, 16, 11], [3, 19, 7, 17, 1, 12]];\n    return create_geom(vertices, faces, radius, 0.2, -Math.PI / 4 / 2, 0.968);\n  };\n\n  var create_d20_geometry = function create_d20_geometry(radius) {\n    var t = (1 + Math.sqrt(5)) / 2;\n    var vertices = [[-1, t, 0], [1, t, 0], [-1, -t, 0], [1, -t, 0], [0, -1, t], [0, 1, t], [0, -1, -t], [0, 1, -t], [t, 0, -1], [t, 0, 1], [-t, 0, -1], [-t, 0, 1]];\n    var faces = [[0, 11, 5, 1], [0, 5, 1, 2], [0, 1, 7, 3], [0, 7, 10, 4], [0, 10, 11, 5], [1, 5, 9, 6], [5, 11, 4, 7], [11, 10, 2, 8], [10, 7, 6, 9], [7, 1, 8, 10], [3, 9, 4, 11], [3, 4, 2, 12], [3, 2, 6, 13], [3, 6, 8, 14], [3, 8, 9, 15], [4, 9, 5, 16], [2, 4, 11, 17], [6, 2, 10, 18], [8, 6, 7, 19], [9, 8, 1, 20]];\n    return create_geom(vertices, faces, radius, -0.2, -Math.PI / 4 / 2, 0.955);\n  };\n\n  var material_options = {\n    specular: 0x172022,\n    color: 0xf0f0f0,\n    shininess: 40,\n    shading: THREE.FlatShading\n  };\n  var label_color = '#aaaaaa';\n  var dice_color = '#202020';\n  var ambient_light_color = 0xf0f5fb;\n  var spot_light_color = 0xefdfd5;\n  var selector_back_colors = {\n    color: 0x404040,\n    shininess: 0,\n    emissive: 0x858787\n  };\n  var desk_color = 0xdfdfdf;\n  var use_shadows = true;\n  var known_types = ['d4', 'd6', 'd8', 'd10', 'd12', 'd20', 'd100'];\n  var dice_face_range = {\n    'd4': [1, 4],\n    'd6': [1, 6],\n    'd8': [1, 8],\n    'd10': [0, 9],\n    'd12': [1, 12],\n    'd20': [1, 20],\n    'd100': [0, 9]\n  };\n  var dice_mass = {\n    'd4': 300,\n    'd6': 300,\n    'd8': 340,\n    'd10': 350,\n    'd12': 350,\n    'd20': 400,\n    'd100': 350\n  };\n  var dice_inertia = {\n    'd4': 5,\n    'd6': 13,\n    'd8': 10,\n    'd10': 9,\n    'd12': 8,\n    'd20': 6,\n    'd100': 9\n  };\n  var scale = 50;\n\n  var create_d4 = function create_d4() {\n    if (!this.d4_geometry) this.d4_geometry = this.create_d4_geometry(this.scale * 1.2);\n    if (!this.d4_material) this.d4_material = new THREE.MeshFaceMaterial(this.create_d4_materials(this.scale / 2, this.scale * 2, d4_labels[0]));\n    return new THREE.Mesh(this.d4_geometry, this.d4_material);\n  };\n\n  var create_d6 = function create_d6() {\n    if (!this.d6_geometry) this.d6_geometry = this.create_d6_geometry(this.scale * 0.9);\n    if (!this.dice_material) this.dice_material = new THREE.MeshFaceMaterial(this.create_dice_materials(this.standart_d20_dice_face_labels, this.scale / 2, 1.0));\n    return new THREE.Mesh(this.d6_geometry, this.dice_material);\n  };\n\n  this.create_d8 = function () {\n    if (!this.d8_geometry) this.d8_geometry = this.create_d8_geometry(this.scale);\n    if (!this.dice_material) this.dice_material = new THREE.MeshFaceMaterial(this.create_dice_materials(this.standart_d20_dice_face_labels, this.scale / 2, 1.2));\n    return new THREE.Mesh(this.d8_geometry, this.dice_material);\n  };\n\n  this.create_d10 = function () {\n    if (!this.d10_geometry) this.d10_geometry = this.create_d10_geometry(this.scale * 0.9);\n    if (!this.dice_material) this.dice_material = new THREE.MeshFaceMaterial(this.create_dice_materials(this.standart_d20_dice_face_labels, this.scale / 2, 1.0));\n    return new THREE.Mesh(this.d10_geometry, this.dice_material);\n  };\n\n  this.create_d12 = function () {\n    if (!this.d12_geometry) this.d12_geometry = this.create_d12_geometry(this.scale * 0.9);\n    if (!this.dice_material) this.dice_material = new THREE.MeshFaceMaterial(this.create_dice_materials(this.standart_d20_dice_face_labels, this.scale / 2, 1.0));\n    return new THREE.Mesh(this.d12_geometry, this.dice_material);\n  };\n\n  this.create_d20 = function () {\n    if (!this.d20_geometry) this.d20_geometry = this.create_d20_geometry(this.scale);\n    if (!this.dice_material) this.dice_material = new THREE.MeshFaceMaterial(this.create_dice_materials(this.standart_d20_dice_face_labels, this.scale / 2, 1.0));\n    return new THREE.Mesh(this.d20_geometry, this.dice_material);\n  };\n\n  this.create_d100 = function () {\n    if (!this.d10_geometry) this.d10_geometry = this.create_d10_geometry(this.scale * 0.9);\n    if (!this.d100_material) this.d100_material = new THREE.MeshFaceMaterial(this.create_dice_materials(this.standart_d100_dice_face_labels, this.scale / 2, 1.5));\n    return new THREE.Mesh(this.d10_geometry, this.d100_material);\n  };\n\n  this.parse_notation = function (notation) {\n    var no = notation.split('@');\n    var dr0 = /\\s*(\\d*)([a-z]+)(\\d+)(\\s*(\\+|\\-)\\s*(\\d+)){0,1}\\s*(\\+|$)/gi;\n    var dr1 = /(\\b)*(\\d+)(\\b)*/gi;\n    var ret = {\n      set: [],\n      constant: 0,\n      result: [],\n      error: false\n    },\n        res;\n\n    while (res = dr0.exec(no[0])) {\n      var command = res[2];\n\n      if (command != 'd') {\n        ret.error = true;\n        continue;\n      }\n\n      var count = parseInt(res[1]);\n      if (res[1] == '') count = 1;\n      var type = 'd' + res[3];\n\n      if (this.known_types.indexOf(type) == -1) {\n        ret.error = true;\n        continue;\n      }\n\n      while (count--) {\n        ret.set.push(type);\n      }\n\n      if (res[5] && res[6]) {\n        if (res[5] == '+') ret.constant += parseInt(res[6]);else ret.constant -= parseInt(res[6]);\n      }\n    }\n\n    while (res = dr1.exec(no[1])) {\n      ret.result.push(parseInt(res[2]));\n    }\n\n    return ret;\n  };\n\n  this.stringify_notation = function (nn) {\n    var dict = {},\n        notation = '';\n\n    for (var i in nn.set) {\n      if (!dict[nn.set[i]]) dict[nn.set[i]] = 1;else ++dict[nn.set[i]];\n    }\n\n    for (var i in dict) {\n      if (notation.length) notation += ' + ';\n      notation += (dict[i] > 1 ? dict[i] : '') + i;\n    }\n\n    if (nn.constant) {\n      if (nn.constant > 0) notation += ' + ' + nn.constant;else notation += ' - ' + Math.abs(nn.constant);\n    }\n\n    return notation;\n  };\n\n  var that = this;\n\n  this.dice_box = function (container, dimentions) {\n    this.use_adapvite_timestep = true;\n    this.animate_selector = true;\n    this.dices = [];\n    this.scene = new THREE.Scene();\n    this.world = new CANNON.World();\n    this.renderer = window.WebGLRenderingContext ? new THREE.WebGLRenderer({\n      antialias: true\n    }) : new THREE.CanvasRenderer({\n      antialias: true\n    });\n    container.appendChild(this.renderer.domElement);\n    this.renderer.shadowMap.enabled = true;\n    this.renderer.shadowMap.type = THREE.PCFShadowMap;\n    this.renderer.setClearColor(0xffffff, 1);\n    this.reinit(container, dimentions);\n    this.world.gravity.set(0, 0, -9.8 * 800);\n    this.world.broadphase = new CANNON.NaiveBroadphase();\n    this.world.solver.iterations = 16;\n    var ambientLight = new THREE.AmbientLight(that.ambient_light_color);\n    this.scene.add(ambientLight);\n    this.dice_body_material = new CANNON.Material();\n    var desk_body_material = new CANNON.Material();\n    var barrier_body_material = new CANNON.Material();\n    this.world.addContactMaterial(new CANNON.ContactMaterial(desk_body_material, this.dice_body_material, 0.01, 0.5));\n    this.world.addContactMaterial(new CANNON.ContactMaterial(barrier_body_material, this.dice_body_material, 0, 1.0));\n    this.world.addContactMaterial(new CANNON.ContactMaterial(this.dice_body_material, this.dice_body_material, 0, 0.5));\n    this.world.add(new CANNON.RigidBody(0, new CANNON.Plane(), desk_body_material));\n    var barrier;\n    barrier = new CANNON.RigidBody(0, new CANNON.Plane(), barrier_body_material);\n    barrier.quaternion.setFromAxisAngle(new CANNON.Vec3(1, 0, 0), Math.PI / 2);\n    barrier.position.set(0, this.h * 0.93, 0);\n    this.world.add(barrier);\n    barrier = new CANNON.RigidBody(0, new CANNON.Plane(), barrier_body_material);\n    barrier.quaternion.setFromAxisAngle(new CANNON.Vec3(1, 0, 0), -Math.PI / 2);\n    barrier.position.set(0, -this.h * 0.93, 0);\n    this.world.add(barrier);\n    barrier = new CANNON.RigidBody(0, new CANNON.Plane(), barrier_body_material);\n    barrier.quaternion.setFromAxisAngle(new CANNON.Vec3(0, 1, 0), -Math.PI / 2);\n    barrier.position.set(this.w * 0.93, 0, 0);\n    this.world.add(barrier);\n    barrier = new CANNON.RigidBody(0, new CANNON.Plane(), barrier_body_material);\n    barrier.quaternion.setFromAxisAngle(new CANNON.Vec3(0, 1, 0), Math.PI / 2);\n    barrier.position.set(-this.w * 0.93, 0, 0);\n    this.world.add(barrier);\n    this.last_time = 0;\n    this.running = false;\n    this.renderer.render(this.scene, this.camera);\n  };\n\n  this.dice_box.prototype.reinit = function (container, dimentions) {\n    this.cw = container.clientWidth / 2;\n    this.ch = container.clientHeight / 2;\n\n    if (dimentions) {\n      this.w = dimentions.w;\n      this.h = dimentions.h;\n    } else {\n      this.w = this.cw;\n      this.h = this.ch;\n    }\n\n    this.aspect = Math.min(this.cw / this.w, this.ch / this.h);\n    that.scale = Math.sqrt(this.w * this.w + this.h * this.h) / 13;\n    this.renderer.setSize(this.cw * 2, this.ch * 2);\n    this.wh = this.ch / this.aspect / Math.tan(10 * Math.PI / 180);\n    if (this.camera) this.scene.remove(this.camera);\n    this.camera = new THREE.PerspectiveCamera(20, this.cw / this.ch, 1, this.wh * 1.3);\n    this.camera.position.z = this.wh;\n    var mw = Math.max(this.w, this.h);\n    if (this.light) this.scene.remove(this.light);\n    this.light = new THREE.SpotLight(that.spot_light_color, 2.0);\n    this.light.position.set(-mw / 2, mw / 2, mw * 2);\n    this.light.target.position.set(0, 0, 0);\n    this.light.distance = mw * 5;\n    this.light.castShadow = true;\n    this.light.shadowCameraNear = mw / 10;\n    this.light.shadowCameraFar = mw * 5;\n    this.light.shadowCameraFov = 50;\n    this.light.shadowBias = 0.001;\n    this.light.shadowDarkness = 1.1;\n    this.light.shadowMapWidth = 1024;\n    this.light.shadowMapHeight = 1024;\n    this.scene.add(this.light);\n    if (this.desk) this.scene.remove(this.desk);\n    this.desk = new THREE.Mesh(new THREE.PlaneGeometry(this.w * 2, this.h * 2, 1, 1), new THREE.MeshPhongMaterial({\n      color: that.desk_color\n    }));\n    this.desk.receiveShadow = that.use_shadows;\n    this.scene.add(this.desk);\n    this.renderer.render(this.scene, this.camera);\n  };\n\n  function make_random_vector(vector) {\n    var random_angle = rnd() * Math.PI / 5 - Math.PI / 5 / 2;\n    var vec = {\n      x: vector.x * Math.cos(random_angle) - vector.y * Math.sin(random_angle),\n      y: vector.x * Math.sin(random_angle) + vector.y * Math.cos(random_angle)\n    };\n    if (vec.x == 0) vec.x = 0.01;\n    if (vec.y == 0) vec.y = 0.01;\n    return vec;\n  }\n\n  this.dice_box.prototype.generate_vectors = function (notation, vector, boost) {\n    var vectors = [];\n\n    for (var i in notation.set) {\n      var vec = make_random_vector(vector);\n      var pos = {\n        x: this.w * (vec.x > 0 ? -1 : 1) * 0.9,\n        y: this.h * (vec.y > 0 ? -1 : 1) * 0.9,\n        z: rnd() * 200 + 200\n      };\n      var projector = Math.abs(vec.x / vec.y);\n      if (projector > 1.0) pos.y /= projector;else pos.x *= projector;\n      var velvec = make_random_vector(vector);\n      var velocity = {\n        x: velvec.x * boost,\n        y: velvec.y * boost,\n        z: -10\n      };\n      var inertia = that.dice_inertia[notation.set[i]];\n      var angle = {\n        x: -(rnd() * vec.y * 5 + inertia * vec.y),\n        y: rnd() * vec.x * 5 + inertia * vec.x,\n        z: 0\n      };\n      var axis = {\n        x: rnd(),\n        y: rnd(),\n        z: rnd(),\n        a: rnd()\n      };\n      vectors.push({\n        set: notation.set[i],\n        pos: pos,\n        velocity: velocity,\n        angle: angle,\n        axis: axis\n      });\n    }\n\n    return vectors;\n  };\n\n  this.dice_box.prototype.create_dice = function (type, pos, velocity, angle, axis) {\n    var dice = that['create_' + type]();\n    dice.castShadow = true;\n    dice.dice_type = type;\n    dice.body = new CANNON.RigidBody(that.dice_mass[type], dice.geometry.cannon_shape, this.dice_body_material);\n    dice.body.position.set(pos.x, pos.y, pos.z);\n    dice.body.quaternion.setFromAxisAngle(new CANNON.Vec3(axis.x, axis.y, axis.z), axis.a * Math.PI * 2);\n    dice.body.angularVelocity.set(angle.x, angle.y, angle.z);\n    dice.body.velocity.set(velocity.x, velocity.y, velocity.z);\n    dice.body.linearDamping = 0.1;\n    dice.body.angularDamping = 0.1;\n    this.scene.add(dice);\n    this.dices.push(dice);\n    this.world.add(dice.body);\n  };\n\n  this.dice_box.prototype.check_if_throw_finished = function () {\n    var res = true;\n    var e = 6;\n\n    if (this.iteration < 10 / that.frame_rate) {\n      for (var i = 0; i < this.dices.length; ++i) {\n        var dice = this.dices[i];\n        if (dice.dice_stopped === true) continue;\n        var a = dice.body.angularVelocity,\n            v = dice.body.velocity;\n\n        if (Math.abs(a.x) < e && Math.abs(a.y) < e && Math.abs(a.z) < e && Math.abs(v.x) < e && Math.abs(v.y) < e && Math.abs(v.z) < e) {\n          if (dice.dice_stopped) {\n            if (this.iteration - dice.dice_stopped > 3) {\n              dice.dice_stopped = true;\n              continue;\n            }\n          } else dice.dice_stopped = this.iteration;\n\n          res = false;\n        } else {\n          dice.dice_stopped = undefined;\n          res = false;\n        }\n      }\n    }\n\n    return res;\n  };\n\n  function get_dice_value(dice) {\n    var vector = new THREE.Vector3(0, 0, dice.dice_type == 'd4' ? -1 : 1);\n    var closest_face,\n        closest_angle = Math.PI * 2;\n\n    for (var i = 0, l = dice.geometry.faces.length; i < l; ++i) {\n      var face = dice.geometry.faces[i];\n      if (face.materialIndex == 0) continue;\n      var angle = face.normal.clone().applyQuaternion(dice.body.quaternion).angleTo(vector);\n\n      if (angle < closest_angle) {\n        closest_angle = angle;\n        closest_face = face;\n      }\n    }\n\n    var matindex = closest_face.materialIndex - 1;\n    if (dice.dice_type == 'd100') matindex *= 10;\n    if (dice.dice_type == 'd10' && matindex == 0) matindex = 10;\n    return matindex;\n  }\n\n  function get_dice_values(dices) {\n    var values = [];\n\n    for (var i = 0, l = dices.length; i < l; ++i) {\n      values.push(get_dice_value(dices[i]));\n    }\n\n    return values;\n  }\n\n  this.dice_box.prototype.emulate_throw = function () {\n    while (!this.check_if_throw_finished()) {\n      ++this.iteration;\n      this.world.step(that.frame_rate);\n    }\n\n    return get_dice_values(this.dices);\n  };\n\n  this.dice_box.prototype.__animate = function (threadid) {\n    var time = new Date().getTime();\n    var time_diff = (time - this.last_time) / 1000;\n    if (time_diff > 3) time_diff = that.frame_rate;\n    ++this.iteration;\n\n    if (this.use_adapvite_timestep) {\n      while (time_diff > that.frame_rate * 1.1) {\n        this.world.step(that.frame_rate);\n        time_diff -= that.frame_rate;\n      }\n\n      this.world.step(time_diff);\n    } else {\n      this.world.step(that.frame_rate);\n    }\n\n    for (var i in this.scene.children) {\n      var interact = this.scene.children[i];\n\n      if (interact.body != undefined) {\n        interact.position.copy(interact.body.position);\n        interact.quaternion.copy(interact.body.quaternion);\n      }\n    }\n\n    this.renderer.render(this.scene, this.camera);\n    this.last_time = this.last_time ? time : new Date().getTime();\n\n    if (this.running == threadid && this.check_if_throw_finished()) {\n      this.running = false;\n      if (this.callback) this.callback.call(this, get_dice_values(this.dices));\n    }\n\n    if (this.running == threadid) {\n      (function (t, tid, uat) {\n        if (!uat && time_diff < that.frame_rate) {\n          setTimeout(function () {\n            requestAnimationFrame(function () {\n              t.__animate(tid);\n            });\n          }, (that.frame_rate - time_diff) * 1000);\n        } else requestAnimationFrame(function () {\n          t.__animate(tid);\n        });\n      })(this, threadid, this.use_adapvite_timestep);\n    }\n  };\n\n  this.dice_box.prototype.clear = function () {\n    this.running = false;\n    var dice;\n\n    while (dice = this.dices.pop()) {\n      this.scene.remove(dice);\n      if (dice.body) this.world.remove(dice.body);\n    }\n\n    if (this.pane) this.scene.remove(this.pane);\n    this.renderer.render(this.scene, this.camera);\n    var box = this;\n    setTimeout(function () {\n      box.renderer.render(box.scene, box.camera);\n    }, 100);\n  };\n\n  this.dice_box.prototype.prepare_dices_for_roll = function (vectors) {\n    this.clear();\n    this.iteration = 0;\n\n    for (var i in vectors) {\n      this.create_dice(vectors[i].set, vectors[i].pos, vectors[i].velocity, vectors[i].angle, vectors[i].axis);\n    }\n  };\n\n  function shift_dice_faces(dice, value, res) {\n    var r = that.dice_face_range[dice.dice_type];\n    if (dice.dice_type == 'd10' && value == 10) value = 0;\n    if (!(value >= r[0] && value <= r[1])) return;\n    var num = value - res;\n    var geom = dice.geometry.clone();\n\n    for (var i = 0, l = geom.faces.length; i < l; ++i) {\n      var matindex = geom.faces[i].materialIndex;\n      if (matindex == 0) continue;\n      matindex += num - 1;\n\n      while (matindex > r[1]) {\n        matindex -= r[1];\n      }\n\n      while (matindex < r[0]) {\n        matindex += r[1];\n      }\n\n      geom.faces[i].materialIndex = matindex + 1;\n    }\n\n    if (dice.dice_type == 'd4' && num != 0) {\n      if (num < 0) num += 4;\n      dice.material = new THREE.MeshFaceMaterial(that.create_d4_materials(that.scale / 2, that.scale * 2, d4_labels[num]));\n    }\n\n    dice.geometry = geom;\n  }\n\n  this.dice_box.prototype.roll = function (vectors, values, callback) {\n    this.prepare_dices_for_roll(vectors);\n\n    if (values != undefined && values.length) {\n      this.use_adapvite_timestep = false;\n      var res = this.emulate_throw();\n      this.prepare_dices_for_roll(vectors);\n\n      for (var i in res) {\n        shift_dice_faces(this.dices[i], values[i], res[i]);\n      }\n    }\n\n    this.callback = callback;\n    this.running = new Date().getTime();\n    this.last_time = 0;\n\n    this.__animate(this.running);\n  };\n\n  this.dice_box.prototype.__selector_animate = function (threadid) {\n    var time = new Date().getTime();\n    var time_diff = (time - this.last_time) / 1000;\n    if (time_diff > 3) time_diff = that.frame_rate;\n    var angle_change = 0.3 * time_diff * Math.PI * Math.min(24000 + threadid - time, 6000) / 6000;\n    if (angle_change < 0) this.running = false;\n\n    for (var i in this.dices) {\n      this.dices[i].rotation.y += angle_change;\n      this.dices[i].rotation.x += angle_change / 4;\n      this.dices[i].rotation.z += angle_change / 10;\n    }\n\n    this.last_time = time;\n    this.renderer.render(this.scene, this.camera);\n\n    if (this.running == threadid) {\n      (function (t, tid) {\n        requestAnimationFrame(function () {\n          t.__selector_animate(tid);\n        });\n      })(this, threadid);\n    }\n  };\n\n  this.dice_box.prototype.search_dice_by_mouse = function (ev) {\n    var m = $t.get_mouse_coords(ev);\n    var intersects = new THREE.Raycaster(this.camera.position, new THREE.Vector3((m.x - this.cw) / this.aspect, 1 - (m.y - this.ch) / this.aspect, this.w / 9).sub(this.camera.position).normalize()).intersectObjects(this.dices);\n    if (intersects.length) return intersects[0].object.userData;\n  };\n\n  this.dice_box.prototype.draw_selector = function () {\n    this.clear();\n    var step = this.w / 4.5;\n    this.pane = new THREE.Mesh(new THREE.PlaneGeometry(this.w * 6, this.h * 6, 1, 1), new THREE.MeshPhongMaterial(that.selector_back_colors));\n    this.pane.receiveShadow = true;\n    this.pane.position.set(0, 0, 1);\n    this.scene.add(this.pane);\n    var mouse_captured = false;\n\n    for (var i = 0, pos = -3; i < that.known_types.length; ++i, ++pos) {\n      var dice = $t.dice['create_' + that.known_types[i]]();\n      dice.position.set(pos * step, 0, step * 0.5);\n      dice.castShadow = true;\n      dice.userData = that.known_types[i];\n      this.dices.push(dice);\n      this.scene.add(dice);\n    }\n\n    this.running = new Date().getTime();\n    this.last_time = 0;\n    if (this.animate_selector) this.__selector_animate(this.running);else this.renderer.render(this.scene, this.camera);\n  };\n\n  function throw_dices(box, vector, boost, dist, notation_getter, before_roll, after_roll) {\n    var uat = $t.dice.use_adapvite_timestep;\n\n    function roll(request_results) {\n      if (after_roll) {\n        box.clear();\n        box.roll(vectors, request_results || notation.result, function (result) {\n          if (after_roll) after_roll.call(box, notation, result);\n          box.rolling = false;\n          $t.dice.use_adapvite_timestep = uat;\n        });\n      }\n    }\n\n    vector.x /= dist;\n    vector.y /= dist;\n    var notation = notation_getter.call(box);\n    if (notation.set.length == 0) return;\n    var vectors = box.generate_vectors(notation, vector, boost);\n    box.rolling = true;\n    if (before_roll) before_roll.call(box, vectors, notation, roll);else roll();\n  }\n\n  this.dice_box.prototype.bind_mouse = function (container, notation_getter, before_roll, after_roll) {\n    var box = this;\n    $t.bind(container, ['mousedown', 'touchstart'], function (ev) {\n      ev.preventDefault();\n      box.mouse_time = new Date().getTime();\n      box.mouse_start = $t.get_mouse_coords(ev);\n    });\n    $t.bind(container, ['mouseup', 'touchend'], function (ev) {\n      if (box.rolling) return;\n      if (box.mouse_start == undefined) return;\n      ev.stopPropagation();\n      var m = $t.get_mouse_coords(ev);\n      var vector = {\n        x: m.x - box.mouse_start.x,\n        y: -(m.y - box.mouse_start.y)\n      };\n      box.mouse_start = undefined;\n      var dist = Math.sqrt(vector.x * vector.x + vector.y * vector.y);\n      if (dist < Math.sqrt(box.w * box.h * 0.01)) return;\n      var time_int = new Date().getTime() - box.mouse_time;\n      if (time_int > 2000) time_int = 2000;\n      var boost = Math.sqrt((2500 - time_int) / 2500) * dist * 2;\n      prepare_rnd(function () {\n        throw_dices(box, vector, boost, dist, notation_getter, before_roll, after_roll);\n      });\n    });\n  };\n\n  this.dice_box.prototype.bind_throw = function (button, notation_getter, before_roll, after_roll) {\n    var box = this;\n    $t.bind(button, ['mouseup', 'touchend'], function (ev) {\n      ev.stopPropagation();\n      box.start_throw(notation_getter, before_roll, after_roll);\n    });\n  };\n\n  this.dice_box.prototype.start_throw = function (notation_getter, before_roll, after_roll) {\n    var box = this;\n    if (box.rolling) return;\n    prepare_rnd(function () {\n      var vector = {\n        x: (rnd() * 2 - 1) * box.w,\n        y: -(rnd() * 2 - 1) * box.h\n      };\n      var dist = Math.sqrt(vector.x * vector.x + vector.y * vector.y);\n      var boost = (rnd() + 3) * dist;\n      throw_dices(box, vector, boost, dist, notation_getter, before_roll, after_roll);\n    });\n  };\n\n  function dice_initialize(container) {\n    $t.remove($t.id('loading_text'));\n    var canvas = $t.id('canvas');\n    canvas.style.width = window.innerWidth - 1 + 'px';\n    canvas.style.height = window.innerHeight - 1 + 'px';\n    var label = $t.id('label');\n    var set = $t.id('set');\n    var selector_div = $t.id('selector_div');\n    var info_div = $t.id('info_div');\n    on_set_change();\n    $t.dice.use_true_random = false;\n\n    function on_set_change(ev) {\n      set.style.width = set.value.length + 3 + 'ex';\n    }\n\n    $t.bind(set, 'keyup', on_set_change);\n    $t.bind(set, 'mousedown', function (ev) {\n      ev.stopPropagation();\n    });\n    $t.bind(set, 'mouseup', function (ev) {\n      ev.stopPropagation();\n    });\n    $t.bind(set, 'focus', function (ev) {\n      $t.set(container, {\n        class: ''\n      });\n    });\n    $t.bind(set, 'blur', function (ev) {\n      $t.set(container, {\n        class: 'noselect'\n      });\n    });\n    $t.bind($t.id('clear'), ['mouseup', 'touchend'], function (ev) {\n      ev.stopPropagation();\n      set.value = '0';\n      on_set_change();\n    });\n    var params = $t.get_url_params();\n\n    if (params.chromakey) {\n      $t.dice.desk_color = 0x00ff00;\n      info_div.style.display = 'none';\n      $t.id('control_panel').style.display = 'none';\n    }\n\n    if (params.shadows == 0) {\n      $t.dice.use_shadows = false;\n    }\n\n    if (params.color == 'white') {\n      $t.dice.dice_color = '#808080';\n      $t.dice.label_color = '#202020';\n    }\n\n    var box = new $t.dice.dice_box(canvas, {\n      w: 500,\n      h: 300\n    });\n    box.animate_selector = false;\n    $t.bind(window, 'resize', function () {\n      canvas.style.width = window.innerWidth - 1 + 'px';\n      canvas.style.height = window.innerHeight - 1 + 'px';\n      box.reinit(canvas, {\n        w: 500,\n        h: 300\n      });\n    });\n\n    function show_selector() {\n      info_div.style.display = 'none';\n      selector_div.style.display = 'inline-block';\n      box.draw_selector();\n    }\n\n    function before_roll(vectors, notation, callback) {\n      info_div.style.display = 'none';\n      selector_div.style.display = 'none';\n      callback();\n    }\n\n    function notation_getter() {\n      return $t.dice.parse_notation(set.value);\n    }\n\n    function after_roll(notation, result) {\n      if (params.chromakey || params.noresult) return;\n      var res = result.join(' ');\n\n      if (notation.constant) {\n        if (notation.constant > 0) res += ' +' + notation.constant;else res += ' -' + Math.abs(notation.constant);\n      }\n\n      if (result.length > 1) res += ' = ' + (result.reduce(function (s, a) {\n        return s + a;\n      }) + notation.constant);\n      label.innerHTML = res;\n      info_div.style.display = 'inline-block';\n    }\n\n    box.bind_mouse(container, notation_getter, before_roll, after_roll);\n    box.bind_throw($t.id('throw'), notation_getter, before_roll, after_roll);\n    $t.bind(container, ['mouseup', 'touchend'], function (ev) {\n      ev.stopPropagation();\n\n      if (selector_div.style.display == 'none') {\n        if (!box.rolling) show_selector();\n        box.rolling = false;\n        return;\n      }\n\n      var name = box.search_dice_by_mouse(ev);\n\n      if (name != undefined) {\n        var notation = $t.dice.parse_notation(set.value);\n        notation.set.push(name);\n        set.value = $t.dice.stringify_notation(notation);\n        on_set_change();\n      }\n    });\n\n    if (params.notation) {\n      set.value = params.notation;\n    }\n\n    if (params.roll) {\n      $t.raise_event($t.id('throw'), 'mouseup');\n    } else {\n      show_selector();\n    }\n  }\n\n  function handleInput(e) {}\n\n  return _jsxs(\"div\", {\n    \"data-dice-body\": true,\n    style: {\n      margin: \"0\"\n    },\n    children: [_jsxs(\"div\", {\n      id: \"control_panel\",\n      className: \"control_panel\",\n      children: [_jsxs(\"h6\", {\n        children: [_jsx(\"img\", {\n          src: \"../favicon.ico\",\n          style: {\n            verticalAlign: \"middle\"\n          }\n        }), \" \", _jsx(\"a\", {\n          href: \"..\",\n          children: \"teal\"\n        }), \" dice\"]\n      }), _jsx(\"p\", {\n        id: \"loading_text\",\n        children: \"Loading libraries, please wait a bit...\"\n      }), _jsx(\"p\", {\n        id: \"info_text\",\n        children: _jsx(\"a\", {\n          href: \"http://www.teall.info/2014/01/online-3d-dice-roller.html\",\n          children: \"More info and help\"\n        })\n      }), _jsx(\"p\", {\n        id: \"info_text\",\n        children: _jsx(\"a\", {\n          href: \"/mdice\",\n          children: \"Multiplayer version\"\n        })\n      })]\n    }), _jsxs(\"div\", {\n      id: \"info_div\",\n      style: {\n        display: \"none\"\n      },\n      children: [_jsx(\"div\", {\n        className: \"center_field\",\n        children: _jsx(\"span\", {\n          id: \"label\"\n        })\n      }), _jsx(\"div\", {\n        className: \"center_field\",\n        children: _jsx(\"div\", {\n          className: \"bottom_field\",\n          children: _jsx(\"span\", {\n            id: \"labelhelp\",\n            children: \"click to continue or tap and drag again\"\n          })\n        })\n      })]\n    }), _jsxs(\"div\", {\n      id: \"selector_div\",\n      style: {\n        display: \"none\"\n      },\n      children: [_jsx(\"div\", {\n        className: \"center_field\",\n        children: _jsxs(\"div\", {\n          id: \"sethelp\",\n          children: [\"choose your dice set by clicking the dices or by direct input of notation,\", _jsx(\"br\", {}), \"tap and drag on free space of screen or hit throw button to roll\"]\n        })\n      }), _jsxs(\"div\", {\n        className: \"center_field\",\n        children: [_jsx(\"input\", {\n          type: \"text\",\n          id: \"set\",\n          value: \"4d6\",\n          onChange: function onChange(e) {\n            return handleInput(e.target.value);\n          }\n        }), _jsx(\"br\", {}), _jsx(\"button\", {\n          id: \"clear\",\n          children: \"clear\"\n        }), _jsx(\"button\", {\n          style: {\n            marginLeft: \"0.6em\"\n          },\n          id: \"throw\",\n          children: \"throw\"\n        })]\n      })]\n    }), _jsx(\"div\", {\n      id: \"canvas\"\n    })]\n  });\n}","map":{"version":3,"names":["$","useEffect","DiceReact","window","teal","$t","copyto","obj","res","Array","i","length","copy","hasOwnProperty","constructor","element","name","props","place","content","dom","document","createElement","setAttribute","appendChild","undefined","inner","sel","nodeName","createTextNode","id","getElementById","set","clas","oldclass","newclass","oc","split","nc","classes","getAttribute","ind","indexOf","splice","push","join","empty","childNodes","removeChild","firstChild","remove","parentNode","bind","eventname","func","bubble","addEventListener","unbind","removeEventListener","one","one_func","e","call","raise_event","cancelable","evt","createEvent","initEvent","dispatchEvent","raise","params","ev","initCustomEvent","getElementsByClassName","get_elements_by_class","node","list","getElementsByTagName","cl","result","j","search","rpc","callback","noparse","ajax","XMLHttpRequest","open","onreadystatechange","readyState","responseText","JSON","parse","send","stringify","uuid","replace","c","r","Math","random","v","toString","get_url_params","location","substring","keyvalue","decodeURI","get_mouse_coords","touches","changedTouches","x","clientX","y","clientY","deferred","solved","callbacks","args","solve","shift","apply","promise","then","arguments","done","resolve","cancel","prototype","slice","when","promises","count","random_storage","use_true_random","frame_rate","prepare_rnd","dice","method","n","random_responce","error","data","rnd","pop","create_shape","vertices","faces","radius","cv","cf","CANNON","Vec3","z","ConvexPolyhedron","make_geom","tab","af","geom","THREE","Geometry","vertex","multiplyScalar","index","ii","fl","aa","PI","Face3","faceVertexUvs","Vector2","cos","sin","computeFaceNormals","boundingSphere","Sphere","Vector3","chamfer_geom","vectors","chamfer","chamfer_vectors","chamfer_faces","corner_faces","center_point","face","vv","clone","add","divideScalar","subVectors","addVectors","pairs","lastm","m","unshift","next_vertex","create_geom","fromArray","normalize","cg","cannon_shape","standart_d20_dice_face_labels","standart_d100_dice_face_labels","calc_texture_size","approx","pow","floor","log","create_dice_materials","face_labels","size","margin","create_text_texture","text","color","back_color","canvas","context","getContext","ts","width","height","font","fillStyle","fillRect","textAlign","textBaseline","fillText","texture","Texture","needsUpdate","materials","MeshPhongMaterial","material_options","map","label_color","dice_color","d4_labels","create_d4_materials","labels","create_d4_text","translate","rotate","create_d4_geometry","create_d6_geometry","create_d8_geometry","create_d10_geometry","a","k","h","b","create_d12_geometry","p","sqrt","q","create_d20_geometry","t","specular","shininess","shading","FlatShading","ambient_light_color","spot_light_color","selector_back_colors","emissive","desk_color","use_shadows","known_types","dice_face_range","dice_mass","dice_inertia","scale","create_d4","d4_geometry","d4_material","MeshFaceMaterial","Mesh","create_d6","d6_geometry","dice_material","create_d8","d8_geometry","create_d10","d10_geometry","create_d12","d12_geometry","create_d20","d20_geometry","create_d100","d100_material","parse_notation","notation","no","dr0","dr1","ret","constant","exec","command","parseInt","type","stringify_notation","nn","dict","abs","that","dice_box","container","dimentions","use_adapvite_timestep","animate_selector","dices","scene","Scene","world","World","renderer","WebGLRenderingContext","WebGLRenderer","antialias","CanvasRenderer","domElement","shadowMap","enabled","PCFShadowMap","setClearColor","reinit","gravity","broadphase","NaiveBroadphase","solver","iterations","ambientLight","AmbientLight","dice_body_material","Material","desk_body_material","barrier_body_material","addContactMaterial","ContactMaterial","RigidBody","Plane","barrier","quaternion","setFromAxisAngle","position","w","last_time","running","render","camera","cw","clientWidth","ch","clientHeight","aspect","min","setSize","wh","tan","PerspectiveCamera","mw","max","light","SpotLight","target","distance","castShadow","shadowCameraNear","shadowCameraFar","shadowCameraFov","shadowBias","shadowDarkness","shadowMapWidth","shadowMapHeight","desk","PlaneGeometry","receiveShadow","make_random_vector","vector","random_angle","vec","generate_vectors","boost","pos","projector","velvec","velocity","inertia","angle","axis","create_dice","dice_type","body","geometry","angularVelocity","linearDamping","angularDamping","check_if_throw_finished","iteration","dice_stopped","get_dice_value","closest_face","closest_angle","l","materialIndex","normal","applyQuaternion","angleTo","matindex","get_dice_values","values","emulate_throw","step","__animate","threadid","time","Date","getTime","time_diff","children","interact","tid","uat","setTimeout","requestAnimationFrame","clear","pane","box","prepare_dices_for_roll","shift_dice_faces","value","num","material","roll","__selector_animate","angle_change","rotation","search_dice_by_mouse","intersects","Raycaster","sub","intersectObjects","object","userData","draw_selector","mouse_captured","throw_dices","dist","notation_getter","before_roll","after_roll","request_results","rolling","bind_mouse","preventDefault","mouse_time","mouse_start","stopPropagation","time_int","bind_throw","button","start_throw","dice_initialize","style","innerWidth","innerHeight","label","selector_div","info_div","on_set_change","class","chromakey","display","shadows","show_selector","noresult","reduce","s","innerHTML","handleInput","verticalAlign","marginLeft"],"sources":["/home/alex/react-dice/dice/DiceReact.js"],"sourcesContent":["\n\nimport $ from 'jquery'\nimport { useEffect } from 'react';\n\n\n\nexport default function DiceReact() {\n\n\n    window.teal = {};\nwindow.$t = window.teal;\n\nteal.copyto = function(obj, res) {\n    if (obj == null || typeof obj !== 'object') return obj;\n    if (obj instanceof Array) {\n        for (var i = obj.length - 1; i >= 0; --i)\n            res[i] = $t.copy(obj[i]);\n    }\n    else {\n        for (var i in obj) {\n            if (obj.hasOwnProperty(i))\n                res[i] = $t.copy(obj[i]);\n        }\n    }\n    return res;\n}\n\nteal.copy = function(obj) {\n    if (!obj) return obj;\n    return teal.copyto(obj, new obj.constructor());\n}\n\nteal.element = function(name, props, place, content) {\n    var dom = document.createElement(name);\n    if (props) for (var i in props) dom.setAttribute(i, props[i]);\n    if (place) place.appendChild(dom);\n    if (content !== undefined) $t.inner(content, dom);\n    return dom;\n}\n\nteal.inner = function(obj, sel) {\n    sel.appendChild(obj.nodeName != undefined ? obj : document.createTextNode(obj));\n    return sel;\n}\n\nteal.id = function(id) {\n    return document.getElementById(id);\n}\n\nteal.set = function(sel, props) {\n    for (var i in props) sel.setAttribute(i, props[i]);\n    return sel;\n}\n\nteal.clas = function(sel, oldclass, newclass) {\n    var oc = oldclass ? oldclass.split(/\\s+/) : [],\n        nc = newclass ? newclass.split(/\\s+/) : [],\n        classes = (sel.getAttribute('class') || '').split(/\\s+/);\n    if (!classes[0]) classes = [];\n    for (var i in oc) {\n        var ind = classes.indexOf(oc[i]);\n        if (ind >= 0) classes.splice(ind, 1);\n    }\n    for (var i in nc) {\n        if (nc[i] && classes.indexOf(nc[i]) < 0) classes.push(nc[i]);\n    }\n    sel.setAttribute('class', classes.join(' '));\n}\n\nteal.empty = function(sel) {\n    if (sel.childNodes)\n        while (sel.childNodes.length)\n            sel.removeChild(sel.firstChild);\n}\n\nteal.remove = function(sel) {\n    if (sel) {\n        if (sel.parentNode) sel.parentNode.removeChild(sel);\n        else for (var i = sel.length - 1; i >= 0; --i)\n            sel[i].parentNode.removeChild(sel[i]);\n    }\n}\n\nteal.bind = function(sel, eventname, func, bubble) {\n    if (!sel) return;\n    if (eventname.constructor === Array) {\n        for (var i in eventname)\n            sel.addEventListener(eventname[i], func, bubble ? bubble : false);\n    }\n    else\n        sel.addEventListener(eventname, func, bubble ? bubble : false);\n}\n\nteal.unbind = function(sel, eventname, func, bubble) {\n    if (eventname.constructor === Array) {\n        for (var i in eventname)\n            sel.removeEventListener(eventname[i], func, bubble ? bubble : false);\n    }\n    else\n        sel.removeEventListener(eventname, func, bubble ? bubble : false);\n}\n\nteal.one = function(sel, eventname, func, bubble) {\n    var one_func = function(e) {\n        func.call(this, e);\n        teal.unbind(sel, eventname, one_func, bubble);\n    };\n    teal.bind(sel, eventname, one_func, bubble);\n}\n\nteal.raise_event = function(sel, eventname, bubble, cancelable) {\n    var evt = document.createEvent('UIEvents');\n    evt.initEvent(eventname, bubble == undefined ? true : bubble,\n            cancelable == undefined ? true : cancelable);\n    sel.dispatchEvent(evt);\n}\n\nteal.raise = function(sel, eventname, params, bubble, cancelable) {\n    var ev = document.createEvent(\"CustomEvent\");\n    ev.initCustomEvent(eventname, bubble, cancelable, params);\n    sel.dispatchEvent(ev);\n}\n\nif (!document.getElementsByClassName) {\n    teal.get_elements_by_class = function(classes, node) {\n        var node = node || document,\n            list = node.getElementsByTagName('*'),\n            cl = classes.split(/\\s+/),\n            result = [];\n\n        for (var i = list.length - 1; i >= 0; --i) {\n            for (var j = cl.length - 1; j >= 0; --j) {\n                var clas = list[i].getAttribute('class');\n                if (clas && clas.search('\\\\b' + cl[j] + '\\\\b') != -1) {\n                    result.push(list[i]);\n                    break;\n                }\n            }\n        }\n        return result;\n    }\n}\nelse {\n    teal.get_elements_by_class = function(classes, node) {\n        return (node || document).getElementsByClassName(classes);\n    }\n}\n\nteal.rpc = function(params, callback, noparse) {\n    var ajax = new XMLHttpRequest();\n    ajax.open(\"post\", 'f', true);\n    ajax.onreadystatechange = function() {\n        if (ajax.readyState == 4)\n            callback.call(ajax, noparse ? ajax.responseText : JSON.parse(ajax.responseText));\n    };\n    ajax.send(JSON.stringify(params));\n}\n\nteal.uuid = function() {\n    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {\n        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);\n        return v.toString(16);\n    });\n}\n\nteal.get_url_params = function() {\n    var params = window.location.search.substring(1).split(\"&\");\n    var res = {};\n    for (var i in params) {\n        var keyvalue = params[i].split(\"=\");\n        res[keyvalue[0]] = decodeURI(keyvalue[1]);\n    }\n    return res;\n}\n\nteal.get_mouse_coords = function(ev) {\n    var touches = ev.changedTouches;\n    if (touches) return { x: touches[0].clientX, y: touches[0].clientY };\n    return { x: ev.clientX, y: ev.clientY };\n}\n\nteal.deferred = function() {\n    var solved = false, callbacks = [], args = [];\n    function solve() {\n        while (callbacks.length) {\n            callbacks.shift().apply(this, args);\n        }\n    }\n    return {\n        promise: function() {\n            return {\n                then: function(callback) {\n                    var deferred = teal.deferred(), promise = deferred.promise();\n                    callbacks.push(function() { \n                        var res = callback.apply(this, arguments);\n                        if (res && 'done' in res) res.done(deferred.resolve);\n                        else deferred.resolve.apply(this, arguments); \n                    });\n                    return promise;\n                },\n                done: function(callback) {\n                    callbacks.push(callback);\n                    if (solved) solve();\n                    return this;\n                },\n                cancel: function() {\n                    callbacks = [];\n                }\n            };\n        },\n        resolve: function() {\n            solved = true;\n            args = Array.prototype.slice.call(arguments, 0);\n            solve();\n        }\n    };\n}\n\nteal.when = function(promises) {\n    var deferred = teal.deferred();\n    var count = promises.length, ind = 0;\n    if (count == 0) deferred.resolve();\n    for (var i = 0; i < count; ++i) {\n        promises[i].done(function() {\n            if (++ind == count) deferred.resolve();\n        });\n    }\n    return deferred.promise();\n}\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n// (function(dice) {\n\n    var random_storage = [];\n    let use_true_random = true;\n    let frame_rate = 1 / 60;\n\n    function prepare_rnd(callback) {\n        if (!random_storage.length && $t.dice.use_true_random) {\n            try {\n                $t.rpc({ method: \"random\", n: 512 }, \n                function(random_responce) {\n                    if (!random_responce.error)\n                        random_storage = random_responce.result.random.data;\n                    else $t.dice.use_true_random = false;\n                    callback();\n                });\n                return;\n            }\n            catch (e) { $t.dice.use_true_random = false; }\n        }\n        callback();\n    }\n\n    function rnd() {\n        return random_storage.length ? random_storage.pop() : Math.random();\n    }\n\n    function create_shape(vertices, faces, radius) {\n        var cv = new Array(vertices.length), cf = new Array(faces.length);\n        for (var i = 0; i < vertices.length; ++i) {\n            var v = vertices[i];\n            cv[i] = new CANNON.Vec3(v.x * radius, v.y * radius, v.z * radius);\n        }\n        for (var i = 0; i < faces.length; ++i) {\n            cf[i] = faces[i].slice(0, faces[i].length - 1);\n        }\n        return new CANNON.ConvexPolyhedron(cv, cf);\n    }\n\n    function make_geom(vertices, faces, radius, tab, af) {\n        var geom = new THREE.Geometry();\n        for (var i = 0; i < vertices.length; ++i) {\n            var vertex = vertices[i].multiplyScalar(radius);\n            vertex.index = geom.vertices.push(vertex) - 1;\n        }\n        for (var i = 0; i < faces.length; ++i) {\n            var ii = faces[i], fl = ii.length - 1;\n            var aa = Math.PI * 2 / fl;\n            for (var j = 0; j < fl - 2; ++j) {\n                geom.faces.push(new THREE.Face3(ii[0], ii[j + 1], ii[j + 2], [geom.vertices[ii[0]],\n                            geom.vertices[ii[j + 1]], geom.vertices[ii[j + 2]]], 0, ii[fl] + 1));\n                geom.faceVertexUvs[0].push([\n                        new THREE.Vector2((Math.cos(af) + 1 + tab) / 2 / (1 + tab),\n                            (Math.sin(af) + 1 + tab) / 2 / (1 + tab)),\n                        new THREE.Vector2((Math.cos(aa * (j + 1) + af) + 1 + tab) / 2 / (1 + tab),\n                            (Math.sin(aa * (j + 1) + af) + 1 + tab) / 2 / (1 + tab)),\n                        new THREE.Vector2((Math.cos(aa * (j + 2) + af) + 1 + tab) / 2 / (1 + tab),\n                            (Math.sin(aa * (j + 2) + af) + 1 + tab) / 2 / (1 + tab))]);\n            }\n        }\n        geom.computeFaceNormals();\n        geom.boundingSphere = new THREE.Sphere(new THREE.Vector3(), radius);\n        return geom;\n    }\n\n    function chamfer_geom(vectors, faces, chamfer) {\n        var chamfer_vectors = [], chamfer_faces = [], corner_faces = new Array(vectors.length);\n        for (var i = 0; i < vectors.length; ++i) corner_faces[i] = [];\n        for (var i = 0; i < faces.length; ++i) {\n            var ii = faces[i], fl = ii.length - 1;\n            var center_point = new THREE.Vector3();\n            var face = new Array(fl);\n            for (var j = 0; j < fl; ++j) {\n                var vv = vectors[ii[j]].clone();\n                center_point.add(vv);\n                corner_faces[ii[j]].push(face[j] = chamfer_vectors.push(vv) - 1);\n            }\n            center_point.divideScalar(fl);\n            for (var j = 0; j < fl; ++j) {\n                var vv = chamfer_vectors[face[j]];\n                vv.subVectors(vv, center_point).multiplyScalar(chamfer).addVectors(vv, center_point);\n            }\n            face.push(ii[fl]);\n            chamfer_faces.push(face);\n        }\n        for (var i = 0; i < faces.length - 1; ++i) {\n            for (var j = i + 1; j < faces.length; ++j) {\n                var pairs = [], lastm = -1;\n                for (var m = 0; m < faces[i].length - 1; ++m) {\n                    var n = faces[j].indexOf(faces[i][m]);\n                    if (n >= 0 && n < faces[j].length - 1) {\n                        if (lastm >= 0 && m != lastm + 1) pairs.unshift([i, m], [j, n]);\n                        else pairs.push([i, m], [j, n]);\n                        lastm = m;\n                    }\n                }\n                if (pairs.length != 4) continue;\n                chamfer_faces.push([chamfer_faces[pairs[0][0]][pairs[0][1]],\n                        chamfer_faces[pairs[1][0]][pairs[1][1]],\n                        chamfer_faces[pairs[3][0]][pairs[3][1]],\n                        chamfer_faces[pairs[2][0]][pairs[2][1]], -1]);\n            }\n        }\n        for (var i = 0; i < corner_faces.length; ++i) {\n            var cf = corner_faces[i], face = [cf[0]], count = cf.length - 1;\n            while (count) {\n                for (var m = faces.length; m < chamfer_faces.length; ++m) {\n                    var index = chamfer_faces[m].indexOf(face[face.length - 1]);\n                    if (index >= 0 && index < 4) {\n                        if (--index == -1) index = 3;\n                        var next_vertex = chamfer_faces[m][index];\n                        if (cf.indexOf(next_vertex) >= 0) {\n                            face.push(next_vertex);\n                            break;\n                        }\n                    }\n                }\n                --count;\n            }\n            face.push(-1);\n            chamfer_faces.push(face);\n        }\n        return { vectors: chamfer_vectors, faces: chamfer_faces };\n    }\n\n    function create_geom(vertices, faces, radius, tab, af, chamfer) {\n        var vectors = new Array(vertices.length);\n        for (var i = 0; i < vertices.length; ++i) {\n            vectors[i] = (new THREE.Vector3).fromArray(vertices[i]).normalize();\n        }\n        var cg = chamfer_geom(vectors, faces, chamfer);\n        var geom = make_geom(cg.vectors, cg.faces, radius, tab, af);\n        //var geom = make_geom(vectors, faces, radius, tab, af); // Without chamfer\n        geom.cannon_shape = create_shape(vectors, faces, radius);\n        return geom;\n    }\n\n    let standart_d20_dice_face_labels = [' ', '0', '1', '2', '3', '4', '5', '6', '7', '8',\n            '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20'];\n    let standart_d100_dice_face_labels = [' ', '00', '10', '20', '30', '40', '50',\n            '60', '70', '80', '90'];\n\n    function calc_texture_size(approx) {\n        return Math.pow(2, Math.floor(Math.log(approx) / Math.log(2)));\n    }\n\n    const create_dice_materials = function(face_labels, size, margin) {\n        function create_text_texture(text, color, back_color) {\n            if (text == undefined) return null;\n            var canvas = document.createElement(\"canvas\");\n            var context = canvas.getContext(\"2d\");\n            var ts = calc_texture_size(size + size * 2 * margin) * 2;\n            canvas.width = canvas.height = ts;\n            context.font = ts / (1 + 2 * margin) + \"pt Arial\";\n            context.fillStyle = back_color;\n            context.fillRect(0, 0, canvas.width, canvas.height);\n            context.textAlign = \"center\";\n            context.textBaseline = \"middle\";\n            context.fillStyle = color;\n            context.fillText(text, canvas.width / 2, canvas.height / 2);\n            if (text == '6' || text == '9') {\n                context.fillText('  .', canvas.width / 2, canvas.height / 2);\n            }\n            var texture = new THREE.Texture(canvas);\n            texture.needsUpdate = true;\n            return texture;\n        }\n        var materials = [];\n        for (var i = 0; i < face_labels.length; ++i)\n            materials.push(new THREE.MeshPhongMaterial($t.copyto(this.material_options,\n                        { map: create_text_texture(face_labels[i], this.label_color, this.dice_color) })));\n        return materials;\n    }\n\n    var d4_labels = [\n        [[], [0, 0, 0], [2, 4, 3], [1, 3, 4], [2, 1, 4], [1, 2, 3]],\n        [[], [0, 0, 0], [2, 3, 4], [3, 1, 4], [2, 4, 1], [3, 2, 1]],\n        [[], [0, 0, 0], [4, 3, 2], [3, 4, 1], [4, 2, 1], [3, 1, 2]],\n        [[], [0, 0, 0], [4, 2, 3], [1, 4, 3], [4, 1, 2], [1, 3, 2]]\n    ];\n\n    const create_d4_materials = function(size, margin, labels) {\n        function create_d4_text(text, color, back_color) {\n            var canvas = document.createElement(\"canvas\");\n            var context = canvas.getContext(\"2d\");\n            var ts = calc_texture_size(size + margin) * 2;\n            canvas.width = canvas.height = ts;\n            context.font = (ts - margin) / 1.5 + \"pt Arial\";\n            context.fillStyle = back_color;\n            context.fillRect(0, 0, canvas.width, canvas.height);\n            context.textAlign = \"center\";\n            context.textBaseline = \"middle\";\n            context.fillStyle = color;\n            for (var i in text) {\n                context.fillText(text[i], canvas.width / 2,\n                        canvas.height / 2 - ts * 0.3);\n                context.translate(canvas.width / 2, canvas.height / 2);\n                context.rotate(Math.PI * 2 / 3);\n                context.translate(-canvas.width / 2, -canvas.height / 2);\n            }\n            var texture = new THREE.Texture(canvas);\n            texture.needsUpdate = true;\n            return texture;\n        }\n        var materials = [];\n        for (var i = 0; i < labels.length; ++i)\n            materials.push(new THREE.MeshPhongMaterial($t.copyto(this.material_options,\n                        { map: create_d4_text(labels[i], this.label_color, this.dice_color) })));\n        return materials;\n    }\n\n    const create_d4_geometry = function(radius) {\n        var vertices = [[1, 1, 1], [-1, -1, 1], [-1, 1, -1], [1, -1, -1]];\n        var faces = [[1, 0, 2, 1], [0, 1, 3, 2], [0, 3, 2, 3], [1, 2, 3, 4]];\n        return create_geom(vertices, faces, radius, -0.1, Math.PI * 7 / 6, 0.96);\n    }\n\n    const create_d6_geometry = function(radius) {\n        var vertices = [[-1, -1, -1], [1, -1, -1], [1, 1, -1], [-1, 1, -1],\n                [-1, -1, 1], [1, -1, 1], [1, 1, 1], [-1, 1, 1]];\n        var faces = [[0, 3, 2, 1, 1], [1, 2, 6, 5, 2], [0, 1, 5, 4, 3],\n                [3, 7, 6, 2, 4], [0, 4, 7, 3, 5], [4, 5, 6, 7, 6]];\n        return create_geom(vertices, faces, radius, 0.1, Math.PI / 4, 0.96);\n    }\n\n    const create_d8_geometry = function(radius) {\n        var vertices = [[1, 0, 0], [-1, 0, 0], [0, 1, 0], [0, -1, 0], [0, 0, 1], [0, 0, -1]];\n        var faces = [[0, 2, 4, 1], [0, 4, 3, 2], [0, 3, 5, 3], [0, 5, 2, 4], [1, 3, 4, 5],\n                [1, 4, 2, 6], [1, 2, 5, 7], [1, 5, 3, 8]];\n        return create_geom(vertices, faces, radius, 0, -Math.PI / 4 / 2, 0.965);\n    }\n\n    const create_d10_geometry = function(radius) {\n        var a = Math.PI * 2 / 10, k = Math.cos(a), h = 0.105, v = -1;\n        var vertices = [];\n        for (var i = 0, b = 0; i < 10; ++i, b += a)\n            vertices.push([Math.cos(b), Math.sin(b), h * (i % 2 ? 1 : -1)]);\n        vertices.push([0, 0, -1]); vertices.push([0, 0, 1]);\n        var faces = [[5, 7, 11, 0], [4, 2, 10, 1], [1, 3, 11, 2], [0, 8, 10, 3], [7, 9, 11, 4],\n                [8, 6, 10, 5], [9, 1, 11, 6], [2, 0, 10, 7], [3, 5, 11, 8], [6, 4, 10, 9],\n                [1, 0, 2, v], [1, 2, 3, v], [3, 2, 4, v], [3, 4, 5, v], [5, 4, 6, v],\n                [5, 6, 7, v], [7, 6, 8, v], [7, 8, 9, v], [9, 8, 0, v], [9, 0, 1, v]];\n        return create_geom(vertices, faces, radius, 0, Math.PI * 6 / 5, 0.945);\n    }\n\n    const create_d12_geometry = function(radius) {\n        var p = (1 + Math.sqrt(5)) / 2, q = 1 / p;\n        var vertices = [[0, q, p], [0, q, -p], [0, -q, p], [0, -q, -p], [p, 0, q],\n                [p, 0, -q], [-p, 0, q], [-p, 0, -q], [q, p, 0], [q, -p, 0], [-q, p, 0],\n                [-q, -p, 0], [1, 1, 1], [1, 1, -1], [1, -1, 1], [1, -1, -1], [-1, 1, 1],\n                [-1, 1, -1], [-1, -1, 1], [-1, -1, -1]];\n        var faces = [[2, 14, 4, 12, 0, 1], [15, 9, 11, 19, 3, 2], [16, 10, 17, 7, 6, 3], [6, 7, 19, 11, 18, 4],\n                [6, 18, 2, 0, 16, 5], [18, 11, 9, 14, 2, 6], [1, 17, 10, 8, 13, 7], [1, 13, 5, 15, 3, 8],\n                [13, 8, 12, 4, 5, 9], [5, 4, 14, 9, 15, 10], [0, 12, 8, 10, 16, 11], [3, 19, 7, 17, 1, 12]];\n        return create_geom(vertices, faces, radius, 0.2, -Math.PI / 4 / 2, 0.968);\n    }\n\n    const create_d20_geometry = function(radius) {\n        var t = (1 + Math.sqrt(5)) / 2;\n        var vertices = [[-1, t, 0], [1, t, 0 ], [-1, -t, 0], [1, -t, 0],\n                [0, -1, t], [0, 1, t], [0, -1, -t], [0, 1, -t],\n                [t, 0, -1], [t, 0, 1], [-t, 0, -1], [-t, 0, 1]];\n        var faces = [[0, 11, 5, 1], [0, 5, 1, 2], [0, 1, 7, 3], [0, 7, 10, 4], [0, 10, 11, 5],\n                [1, 5, 9, 6], [5, 11, 4, 7], [11, 10, 2, 8], [10, 7, 6, 9], [7, 1, 8, 10],\n                [3, 9, 4, 11], [3, 4, 2, 12], [3, 2, 6, 13], [3, 6, 8, 14], [3, 8, 9, 15],\n                [4, 9, 5, 16], [2, 4, 11, 17], [6, 2, 10, 18], [8, 6, 7, 19], [9, 8, 1, 20]];\n        return create_geom(vertices, faces, radius, -0.2, -Math.PI / 4 / 2, 0.955);\n    }\n\n    let material_options = {\n        specular: 0x172022,\n        color: 0xf0f0f0,\n        shininess: 40,\n        shading: THREE.FlatShading,\n    };\n    let label_color = '#aaaaaa';\n    let dice_color = '#202020';\n    let ambient_light_color = 0xf0f5fb;\n    let spot_light_color = 0xefdfd5;\n    let selector_back_colors = { color: 0x404040, shininess: 0, emissive: 0x858787 };\n    let desk_color = 0xdfdfdf;\n    let use_shadows = true;\n\n    let known_types = ['d4', 'd6', 'd8', 'd10', 'd12', 'd20', 'd100'];\n    let dice_face_range = { 'd4': [1, 4], 'd6': [1, 6], 'd8': [1, 8], 'd10': [0, 9], \n        'd12': [1, 12], 'd20': [1, 20], 'd100': [0, 9] };\n    let dice_mass = { 'd4': 300, 'd6': 300, 'd8': 340, 'd10': 350, 'd12': 350, 'd20': 400, 'd100': 350 };\n    let dice_inertia = { 'd4': 5, 'd6': 13, 'd8': 10, 'd10': 9, 'd12': 8, 'd20': 6, 'd100': 9 };\n\n    let scale = 50;\n\n    let create_d4 = function() {\n        if (!this.d4_geometry) this.d4_geometry = this.create_d4_geometry(this.scale * 1.2);\n        if (!this.d4_material) this.d4_material = new THREE.MeshFaceMaterial(\n                this.create_d4_materials(this.scale / 2, this.scale * 2, d4_labels[0]));\n        return new THREE.Mesh(this.d4_geometry, this.d4_material);\n    }\n\n    let create_d6 = function() {\n        if (!this.d6_geometry) this.d6_geometry = this.create_d6_geometry(this.scale * 0.9);\n        if (!this.dice_material) this.dice_material = new THREE.MeshFaceMaterial(\n                this.create_dice_materials(this.standart_d20_dice_face_labels, this.scale / 2, 1.0));\n        return new THREE.Mesh(this.d6_geometry, this.dice_material);\n    }\n\n    this.create_d8 = function() {\n        if (!this.d8_geometry) this.d8_geometry = this.create_d8_geometry(this.scale);\n        if (!this.dice_material) this.dice_material = new THREE.MeshFaceMaterial(\n                this.create_dice_materials(this.standart_d20_dice_face_labels, this.scale / 2, 1.2));\n        return new THREE.Mesh(this.d8_geometry, this.dice_material);\n    }\n\n    this.create_d10 = function() {\n        if (!this.d10_geometry) this.d10_geometry = this.create_d10_geometry(this.scale * 0.9);\n        if (!this.dice_material) this.dice_material = new THREE.MeshFaceMaterial(\n                this.create_dice_materials(this.standart_d20_dice_face_labels, this.scale / 2, 1.0));\n        return new THREE.Mesh(this.d10_geometry, this.dice_material);\n    }\n\n    this.create_d12 = function() {\n        if (!this.d12_geometry) this.d12_geometry = this.create_d12_geometry(this.scale * 0.9);\n        if (!this.dice_material) this.dice_material = new THREE.MeshFaceMaterial(\n                this.create_dice_materials(this.standart_d20_dice_face_labels, this.scale / 2, 1.0));\n        return new THREE.Mesh(this.d12_geometry, this.dice_material);\n    }\n\n    this.create_d20 = function() {\n        if (!this.d20_geometry) this.d20_geometry = this.create_d20_geometry(this.scale);\n        if (!this.dice_material) this.dice_material = new THREE.MeshFaceMaterial(\n                this.create_dice_materials(this.standart_d20_dice_face_labels, this.scale / 2, 1.0));\n        return new THREE.Mesh(this.d20_geometry, this.dice_material);\n    }\n\n    this.create_d100 = function() {\n        if (!this.d10_geometry) this.d10_geometry = this.create_d10_geometry(this.scale * 0.9);\n        if (!this.d100_material) this.d100_material = new THREE.MeshFaceMaterial(\n                this.create_dice_materials(this.standart_d100_dice_face_labels, this.scale / 2, 1.5));\n        return new THREE.Mesh(this.d10_geometry, this.d100_material);\n    }\n\n    this.parse_notation = function(notation) {\n        var no = notation.split('@');\n        var dr0 = /\\s*(\\d*)([a-z]+)(\\d+)(\\s*(\\+|\\-)\\s*(\\d+)){0,1}\\s*(\\+|$)/gi;\n        var dr1 = /(\\b)*(\\d+)(\\b)*/gi;\n        var ret = { set: [], constant: 0, result: [], error: false }, res;\n        while (res = dr0.exec(no[0])) {\n            var command = res[2];\n            if (command != 'd') { ret.error = true; continue; }\n            var count = parseInt(res[1]);\n            if (res[1] == '') count = 1;\n            var type = 'd' + res[3];\n            if (this.known_types.indexOf(type) == -1) { ret.error = true; continue; }\n            while (count--) ret.set.push(type);\n            if (res[5] && res[6]) {\n                if (res[5] == '+') ret.constant += parseInt(res[6]);\n                else ret.constant -= parseInt(res[6]);\n            }\n        }\n        while (res = dr1.exec(no[1])) {\n            ret.result.push(parseInt(res[2]));\n        }\n        return ret;\n    }\n\n    this.stringify_notation = function(nn) {\n        var dict = {}, notation = '';\n        for (var i in nn.set) \n            if (!dict[nn.set[i]]) dict[nn.set[i]] = 1; else ++dict[nn.set[i]];\n        for (var i in dict) {\n            if (notation.length) notation += ' + ';\n            notation += (dict[i] > 1 ? dict[i] : '') + i;\n        }\n        if (nn.constant) {\n            if (nn.constant > 0) notation += ' + ' + nn.constant;\n            else notation += ' - ' + Math.abs(nn.constant);\n        }\n        return notation;\n    }\n\n    var that = this;\n\n    this.dice_box = function(container, dimentions) {\n        this.use_adapvite_timestep = true;\n        this.animate_selector = true;\n\n        this.dices = [];\n        this.scene = new THREE.Scene();\n        this.world = new CANNON.World();\n\n        this.renderer = window.WebGLRenderingContext\n            ? new THREE.WebGLRenderer({ antialias: true })\n            : new THREE.CanvasRenderer({ antialias: true });\n        container.appendChild(this.renderer.domElement);\n        this.renderer.shadowMap.enabled = true;\n        this.renderer.shadowMap.type = THREE.PCFShadowMap;\n        this.renderer.setClearColor(0xffffff, 1);\n\n        this.reinit(container, dimentions);\n\n        this.world.gravity.set(0, 0, -9.8 * 800);\n        this.world.broadphase = new CANNON.NaiveBroadphase();\n        this.world.solver.iterations = 16;\n\n        var ambientLight = new THREE.AmbientLight(that.ambient_light_color);\n        this.scene.add(ambientLight);\n\n        this.dice_body_material = new CANNON.Material();\n        var desk_body_material = new CANNON.Material();\n        var barrier_body_material = new CANNON.Material();\n        this.world.addContactMaterial(new CANNON.ContactMaterial(\n                    desk_body_material, this.dice_body_material, 0.01, 0.5));\n        this.world.addContactMaterial(new CANNON.ContactMaterial(\n                    barrier_body_material, this.dice_body_material, 0, 1.0));\n        this.world.addContactMaterial(new CANNON.ContactMaterial(\n                    this.dice_body_material, this.dice_body_material, 0, 0.5));\n\n        this.world.add(new CANNON.RigidBody(0, new CANNON.Plane(), desk_body_material));\n        var barrier;\n        barrier = new CANNON.RigidBody(0, new CANNON.Plane(), barrier_body_material);\n        barrier.quaternion.setFromAxisAngle(new CANNON.Vec3(1, 0, 0), Math.PI / 2);\n        barrier.position.set(0, this.h * 0.93, 0);\n        this.world.add(barrier);\n\n        barrier = new CANNON.RigidBody(0, new CANNON.Plane(), barrier_body_material);\n        barrier.quaternion.setFromAxisAngle(new CANNON.Vec3(1, 0, 0), -Math.PI / 2);\n        barrier.position.set(0, -this.h * 0.93, 0);\n        this.world.add(barrier);\n\n        barrier = new CANNON.RigidBody(0, new CANNON.Plane(), barrier_body_material);\n        barrier.quaternion.setFromAxisAngle(new CANNON.Vec3(0, 1, 0), -Math.PI / 2);\n        barrier.position.set(this.w * 0.93, 0, 0);\n        this.world.add(barrier);\n\n        barrier = new CANNON.RigidBody(0, new CANNON.Plane(), barrier_body_material);\n        barrier.quaternion.setFromAxisAngle(new CANNON.Vec3(0, 1, 0), Math.PI / 2);\n        barrier.position.set(-this.w * 0.93, 0, 0);\n        this.world.add(barrier);\n\n        this.last_time = 0;\n        this.running = false;\n\n        this.renderer.render(this.scene, this.camera);\n    }\n\n    this.dice_box.prototype.reinit = function(container, dimentions) {\n        this.cw = container.clientWidth / 2;\n        this.ch = container.clientHeight / 2;\n        if (dimentions) {\n            this.w = dimentions.w;\n            this.h = dimentions.h;\n        }\n        else {\n            this.w = this.cw;\n            this.h = this.ch;\n        }\n        this.aspect = Math.min(this.cw / this.w, this.ch / this.h);\n        that.scale = Math.sqrt(this.w * this.w + this.h * this.h) / 13;\n\n        this.renderer.setSize(this.cw * 2, this.ch * 2);\n\n        this.wh = this.ch / this.aspect / Math.tan(10 * Math.PI / 180);\n        if (this.camera) this.scene.remove(this.camera);\n        this.camera = new THREE.PerspectiveCamera(20, this.cw / this.ch, 1, this.wh * 1.3);\n        this.camera.position.z = this.wh;\n\n        var mw = Math.max(this.w, this.h);\n        if (this.light) this.scene.remove(this.light);\n        this.light = new THREE.SpotLight(that.spot_light_color, 2.0);\n        this.light.position.set(-mw / 2, mw / 2, mw * 2);\n        this.light.target.position.set(0, 0, 0);\n        this.light.distance = mw * 5;\n        this.light.castShadow = true;\n        this.light.shadowCameraNear = mw / 10;\n        this.light.shadowCameraFar = mw * 5;\n        this.light.shadowCameraFov = 50;\n        this.light.shadowBias = 0.001;\n        this.light.shadowDarkness = 1.1;\n        this.light.shadowMapWidth = 1024;\n        this.light.shadowMapHeight = 1024;\n        this.scene.add(this.light);\n\n        if (this.desk) this.scene.remove(this.desk);\n        this.desk = new THREE.Mesh(new THREE.PlaneGeometry(this.w * 2, this.h * 2, 1, 1), \n                new THREE.MeshPhongMaterial({ color: that.desk_color }));\n        this.desk.receiveShadow = that.use_shadows;\n        this.scene.add(this.desk);\n\n        this.renderer.render(this.scene, this.camera);\n    }\n\n    function make_random_vector(vector) {\n        var random_angle = rnd() * Math.PI / 5 - Math.PI / 5 / 2;\n        var vec = {\n            x: vector.x * Math.cos(random_angle) - vector.y * Math.sin(random_angle),\n            y: vector.x * Math.sin(random_angle) + vector.y * Math.cos(random_angle)\n        };\n        if (vec.x == 0) vec.x = 0.01;\n        if (vec.y == 0) vec.y = 0.01;\n        return vec;\n    }\n\n    this.dice_box.prototype.generate_vectors = function(notation, vector, boost) {\n        var vectors = [];\n        for (var i in notation.set) {\n            var vec = make_random_vector(vector);\n            var pos = {\n                x: this.w * (vec.x > 0 ? -1 : 1) * 0.9,\n                y: this.h * (vec.y > 0 ? -1 : 1) * 0.9,\n                z: rnd() * 200 + 200\n            };\n            var projector = Math.abs(vec.x / vec.y);\n            if (projector > 1.0) pos.y /= projector; else pos.x *= projector;\n            var velvec = make_random_vector(vector);\n            var velocity = { x: velvec.x * boost, y: velvec.y * boost, z: -10 };\n            var inertia = that.dice_inertia[notation.set[i]];\n            var angle = {\n                x: -(rnd() * vec.y * 5 + inertia * vec.y),\n                y: rnd() * vec.x * 5 + inertia * vec.x,\n                z: 0\n            };\n            var axis = { x: rnd(), y: rnd(), z: rnd(), a: rnd() };\n            vectors.push({ set: notation.set[i], pos: pos, velocity: velocity, angle: angle, axis: axis });\n        }\n        return vectors;\n    }\n\n    this.dice_box.prototype.create_dice = function(type, pos, velocity, angle, axis) {\n        var dice = that['create_' + type]();\n        dice.castShadow = true;\n        dice.dice_type = type;\n        dice.body = new CANNON.RigidBody(that.dice_mass[type],\n                dice.geometry.cannon_shape, this.dice_body_material);\n        dice.body.position.set(pos.x, pos.y, pos.z);\n        dice.body.quaternion.setFromAxisAngle(new CANNON.Vec3(axis.x, axis.y, axis.z), axis.a * Math.PI * 2);\n        dice.body.angularVelocity.set(angle.x, angle.y, angle.z);\n        dice.body.velocity.set(velocity.x, velocity.y, velocity.z);\n        dice.body.linearDamping = 0.1;\n        dice.body.angularDamping = 0.1;\n        this.scene.add(dice);\n        this.dices.push(dice);\n        this.world.add(dice.body);\n    }\n\n    this.dice_box.prototype.check_if_throw_finished = function() {\n        var res = true;\n        var e = 6;\n        if (this.iteration < 10 / that.frame_rate) {\n            for (var i = 0; i < this.dices.length; ++i) {\n                var dice = this.dices[i];\n                if (dice.dice_stopped === true) continue;\n                var a = dice.body.angularVelocity, v = dice.body.velocity;\n                if (Math.abs(a.x) < e && Math.abs(a.y) < e && Math.abs(a.z) < e &&\n                        Math.abs(v.x) < e && Math.abs(v.y) < e && Math.abs(v.z) < e) {\n                    if (dice.dice_stopped) {\n                        if (this.iteration - dice.dice_stopped > 3) {\n                            dice.dice_stopped = true;\n                            continue;\n                        }\n                    }\n                    else dice.dice_stopped = this.iteration;\n                    res = false;\n                }\n                else {\n                    dice.dice_stopped = undefined;\n                    res = false;\n                }\n            }\n        }\n        return res;\n    }\n\n    function get_dice_value(dice) {\n        var vector = new THREE.Vector3(0, 0, dice.dice_type == 'd4' ? -1 : 1);\n        var closest_face, closest_angle = Math.PI * 2;\n        for (var i = 0, l = dice.geometry.faces.length; i < l; ++i) {\n            var face = dice.geometry.faces[i];\n            if (face.materialIndex == 0) continue;\n            var angle = face.normal.clone().applyQuaternion(dice.body.quaternion).angleTo(vector);\n            if (angle < closest_angle) {\n                closest_angle = angle;\n                closest_face = face;\n            }\n        }\n        var matindex = closest_face.materialIndex - 1;\n        if (dice.dice_type == 'd100') matindex *= 10;\n        if (dice.dice_type == 'd10' && matindex == 0) matindex = 10;\n        return matindex;\n    }\n\n    function get_dice_values(dices) {\n        var values = [];\n        for (var i = 0, l = dices.length; i < l; ++i) {\n            values.push(get_dice_value(dices[i]));\n        }\n        return values;\n    }\n\n    this.dice_box.prototype.emulate_throw = function() {\n        while (!this.check_if_throw_finished()) {\n            ++this.iteration;\n            this.world.step(that.frame_rate);\n        }\n        return get_dice_values(this.dices);\n    }\n\n    this.dice_box.prototype.__animate = function(threadid) {\n        var time = (new Date()).getTime();\n        var time_diff = (time - this.last_time) / 1000;\n        if (time_diff > 3) time_diff = that.frame_rate;\n        ++this.iteration;\n        if (this.use_adapvite_timestep) {\n            while (time_diff > that.frame_rate * 1.1) {\n                this.world.step(that.frame_rate);\n                time_diff -= that.frame_rate;\n            }\n            this.world.step(time_diff);\n        }\n        else {\n            this.world.step(that.frame_rate);\n        }\n        for (var i in this.scene.children) {\n            var interact = this.scene.children[i];\n            if (interact.body != undefined) {\n                interact.position.copy(interact.body.position);\n                interact.quaternion.copy(interact.body.quaternion);\n            }\n        }\n        this.renderer.render(this.scene, this.camera);\n        this.last_time = this.last_time ? time : (new Date()).getTime();\n        if (this.running == threadid && this.check_if_throw_finished()) {\n            this.running = false;\n            if (this.callback) this.callback.call(this, get_dice_values(this.dices));\n        }\n        if (this.running == threadid) {\n            (function(t, tid, uat) {\n                if (!uat && time_diff < that.frame_rate) {\n                    setTimeout(function() { requestAnimationFrame(function() { t.__animate(tid); }); },\n                        (that.frame_rate - time_diff) * 1000);\n                }\n                else requestAnimationFrame(function() { t.__animate(tid); });\n            })(this, threadid, this.use_adapvite_timestep);\n        }\n    }\n\n    this.dice_box.prototype.clear = function() {\n        this.running = false;\n        var dice;\n        while (dice = this.dices.pop()) {\n            this.scene.remove(dice); \n            if (dice.body) this.world.remove(dice.body);\n        }\n        if (this.pane) this.scene.remove(this.pane);\n        this.renderer.render(this.scene, this.camera);\n        var box = this;\n        setTimeout(function() { box.renderer.render(box.scene, box.camera); }, 100);\n    }\n\n    this.dice_box.prototype.prepare_dices_for_roll = function(vectors) {\n        this.clear();\n        this.iteration = 0;\n        for (var i in vectors) {\n            this.create_dice(vectors[i].set, vectors[i].pos, vectors[i].velocity,\n                    vectors[i].angle, vectors[i].axis);\n        }\n    }\n\n    function shift_dice_faces(dice, value, res) {\n        var r = that.dice_face_range[dice.dice_type];\n        if (dice.dice_type == 'd10' && value == 10) value = 0;\n        if (!(value >= r[0] && value <= r[1])) return;\n        var num = value - res;\n        var geom = dice.geometry.clone();\n        for (var i = 0, l = geom.faces.length; i < l; ++i) {\n            var matindex = geom.faces[i].materialIndex;\n            if (matindex == 0) continue;\n            matindex += num - 1;\n            while (matindex > r[1]) matindex -= r[1];\n            while (matindex < r[0]) matindex += r[1];\n            geom.faces[i].materialIndex = matindex + 1;\n        }\n        if (dice.dice_type == 'd4' && num != 0) {\n            if (num < 0) num += 4;\n            dice.material = new THREE.MeshFaceMaterial(\n                    that.create_d4_materials(that.scale / 2, that.scale * 2, d4_labels[num]));\n        }\n        dice.geometry = geom;\n    }\n\n    this.dice_box.prototype.roll = function(vectors, values, callback) {\n        this.prepare_dices_for_roll(vectors);\n        if (values != undefined && values.length) {\n            this.use_adapvite_timestep = false;\n            var res = this.emulate_throw();\n            this.prepare_dices_for_roll(vectors);\n            for (var i in res)\n                shift_dice_faces(this.dices[i], values[i], res[i]);\n        }\n        this.callback = callback;\n        this.running = (new Date()).getTime();\n        this.last_time = 0;\n        this.__animate(this.running);\n    }\n\n    this.dice_box.prototype.__selector_animate = function(threadid) {\n        var time = (new Date()).getTime();\n        var time_diff = (time - this.last_time) / 1000;\n        if (time_diff > 3) time_diff = that.frame_rate;\n        var angle_change = 0.3 * time_diff * Math.PI * Math.min(24000 + threadid - time, 6000) / 6000;\n        if (angle_change < 0) this.running = false;\n        for (var i in this.dices) {\n            this.dices[i].rotation.y += angle_change;\n            this.dices[i].rotation.x += angle_change / 4;\n            this.dices[i].rotation.z += angle_change / 10;\n        }\n        this.last_time = time;\n        this.renderer.render(this.scene, this.camera);\n        if (this.running == threadid) {\n            (function(t, tid) {\n                requestAnimationFrame(function() { t.__selector_animate(tid); });\n            })(this, threadid);\n        }\n    }\n\n    this.dice_box.prototype.search_dice_by_mouse = function(ev) {\n        var m = $t.get_mouse_coords(ev);\n        var intersects = (new THREE.Raycaster(this.camera.position, \n                    (new THREE.Vector3((m.x - this.cw) / this.aspect,\n                                       1 - (m.y - this.ch) / this.aspect, this.w / 9))\n                    .sub(this.camera.position).normalize())).intersectObjects(this.dices);\n        if (intersects.length) return intersects[0].object.userData;\n    }\n\n    this.dice_box.prototype.draw_selector = function() {\n        this.clear();\n        var step = this.w / 4.5;\n        this.pane = new THREE.Mesh(new THREE.PlaneGeometry(this.w * 6, this.h * 6, 1, 1), \n                new THREE.MeshPhongMaterial(that.selector_back_colors));\n        this.pane.receiveShadow = true;\n        this.pane.position.set(0, 0, 1);\n        this.scene.add(this.pane);\n\n        var mouse_captured = false;\n\n        for (var i = 0, pos = -3; i < that.known_types.length; ++i, ++pos) {\n            var dice = $t.dice['create_' + that.known_types[i]]();\n            dice.position.set(pos * step, 0, step * 0.5);\n            dice.castShadow = true;\n            dice.userData = that.known_types[i];\n            this.dices.push(dice); this.scene.add(dice);\n        }\n\n        this.running = (new Date()).getTime();\n        this.last_time = 0;\n        if (this.animate_selector) this.__selector_animate(this.running);\n        else this.renderer.render(this.scene, this.camera);\n    }\n\n    function throw_dices(box, vector, boost, dist, notation_getter, before_roll, after_roll) {\n        var uat = $t.dice.use_adapvite_timestep;\n        function roll(request_results) {\n            if (after_roll) {\n                box.clear();\n                box.roll(vectors, request_results || notation.result, function(result) {\n                    if (after_roll) after_roll.call(box, notation, result);\n                    box.rolling = false;\n                    $t.dice.use_adapvite_timestep = uat;\n                });\n            }\n        }\n        vector.x /= dist; vector.y /= dist;\n        var notation = notation_getter.call(box);\n        if (notation.set.length == 0) return;\n        var vectors = box.generate_vectors(notation, vector, boost);\n        box.rolling = true;\n        if (before_roll) before_roll.call(box, vectors, notation, roll);\n        else roll();\n    }\n\n    this.dice_box.prototype.bind_mouse = function(container, notation_getter, before_roll, after_roll) {\n        var box = this;\n        $t.bind(container, ['mousedown', 'touchstart'], function(ev) {\n            ev.preventDefault();\n            box.mouse_time = (new Date()).getTime();\n            box.mouse_start = $t.get_mouse_coords(ev);\n        });\n        $t.bind(container, ['mouseup', 'touchend'], function(ev) {\n            if (box.rolling) return;\n            if (box.mouse_start == undefined) return;\n            ev.stopPropagation();\n            var m = $t.get_mouse_coords(ev);\n            var vector = { x: m.x - box.mouse_start.x, y: -(m.y - box.mouse_start.y) };\n            box.mouse_start = undefined;\n            var dist = Math.sqrt(vector.x * vector.x + vector.y * vector.y);\n            if (dist < Math.sqrt(box.w * box.h * 0.01)) return;\n            var time_int = (new Date()).getTime() - box.mouse_time;\n            if (time_int > 2000) time_int = 2000;\n            var boost = Math.sqrt((2500 - time_int) / 2500) * dist * 2;\n            prepare_rnd(function() {\n                throw_dices(box, vector, boost, dist, notation_getter, before_roll, after_roll);\n            });\n        });\n    }\n\n    this.dice_box.prototype.bind_throw = function(button, notation_getter, before_roll, after_roll) {\n        var box = this;\n        $t.bind(button, ['mouseup', 'touchend'], function(ev) {\n            ev.stopPropagation();\n            box.start_throw(notation_getter, before_roll, after_roll);\n        });\n    }\n\n    this.dice_box.prototype.start_throw = function(notation_getter, before_roll, after_roll) {\n        var box = this;\n        if (box.rolling) return;\n        prepare_rnd(function() {\n            var vector = { x: (rnd() * 2 - 1) * box.w, y: -(rnd() * 2 - 1) * box.h };\n            var dist = Math.sqrt(vector.x * vector.x + vector.y * vector.y);\n            var boost = (rnd() + 3) * dist;\n            throw_dices(box, vector, boost, dist, notation_getter, before_roll, after_roll);\n        });\n    }\n\n// }).apply(teal.dice = teal.dice || {});\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nfunction dice_initialize(container) {\n    $t.remove($t.id('loading_text'));\n\n    var canvas = $t.id('canvas');\n    canvas.style.width = window.innerWidth - 1 + 'px';\n    canvas.style.height = window.innerHeight - 1 + 'px';\n    var label = $t.id('label');\n    var set = $t.id('set');\n    var selector_div = $t.id('selector_div');\n    var info_div = $t.id('info_div');\n    on_set_change();\n\n    $t.dice.use_true_random = false;\n\n    function on_set_change(ev) { set.style.width = set.value.length + 3 + 'ex'; }\n    $t.bind(set, 'keyup', on_set_change);\n    $t.bind(set, 'mousedown', function(ev) { ev.stopPropagation(); });\n    $t.bind(set, 'mouseup', function(ev) { ev.stopPropagation(); });\n    $t.bind(set, 'focus', function(ev) { $t.set(container, { class: '' }); });\n    $t.bind(set, 'blur', function(ev) { $t.set(container, { class: 'noselect' }); });\n\n    $t.bind($t.id('clear'), ['mouseup', 'touchend'], function(ev) {\n        ev.stopPropagation();\n        set.value = '0';\n        on_set_change();\n    });\n\n    var params = $t.get_url_params();\n\n    if (params.chromakey) {\n        $t.dice.desk_color = 0x00ff00;\n        info_div.style.display = 'none';\n        $t.id('control_panel').style.display = 'none';\n    }\n    if (params.shadows == 0) {\n        $t.dice.use_shadows = false;\n    }\n    if (params.color == 'white') {\n        $t.dice.dice_color = '#808080';\n        $t.dice.label_color = '#202020';\n    }\n\n    var box = new $t.dice.dice_box(canvas, { w: 500, h: 300 });\n    box.animate_selector = false;\n\n    $t.bind(window, 'resize', function() {\n        canvas.style.width = window.innerWidth - 1 + 'px';\n        canvas.style.height = window.innerHeight - 1 + 'px';\n        box.reinit(canvas, { w: 500, h: 300 });\n    });\n\n    function show_selector() {\n        info_div.style.display = 'none';\n        selector_div.style.display = 'inline-block';\n        box.draw_selector();\n    }\n\n    function before_roll(vectors, notation, callback) {\n        info_div.style.display = 'none';\n        selector_div.style.display = 'none';\n        // do here rpc call or whatever to get your own result of throw.\n        // then callback with array of your result, example:\n        // callback([2, 2, 2, 2]); // for 4d6 where all dice values are 2.\n        callback();\n    }\n\n    function notation_getter() {\n        return $t.dice.parse_notation(set.value);\n    }\n\n    function after_roll(notation, result) {\n        if (params.chromakey || params.noresult) return;\n        var res = result.join(' ');\n        if (notation.constant) {\n            if (notation.constant > 0) res += ' +' + notation.constant;\n            else res += ' -' + Math.abs(notation.constant);\n        }\n        if (result.length > 1) res += ' = ' + \n                (result.reduce(function(s, a) { return s + a; }) + notation.constant);\n        label.innerHTML = res;\n        info_div.style.display = 'inline-block';\n    }\n\n    box.bind_mouse(container, notation_getter, before_roll, after_roll);\n    box.bind_throw($t.id('throw'), notation_getter, before_roll, after_roll);\n\n    $t.bind(container, ['mouseup', 'touchend'], function(ev) {\n        ev.stopPropagation();\n        if (selector_div.style.display == 'none') {\n            if (!box.rolling) show_selector();\n            box.rolling = false;\n            return;\n        }\n        var name = box.search_dice_by_mouse(ev);\n        if (name != undefined) {\n            var notation = $t.dice.parse_notation(set.value);\n            notation.set.push(name);\n            set.value = $t.dice.stringify_notation(notation);\n            on_set_change();\n        }\n    });\n\n    if (params.notation) {\n        set.value = params.notation;\n    }\n    if (params.roll) {\n        $t.raise_event($t.id('throw'), 'mouseup');\n    }\n    else {\n        show_selector();\n    }\n}\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n \n  function handleInput(e) {\n\n  }\n\n  return (\n    <div data-dice-body style={{margin: \"0\"}}>\n      <div id=\"control_panel\" className=\"control_panel\">\n          <h6><img src=\"../favicon.ico\" style={{verticalAlign: \"middle\"}}></img> <a href=\"..\">teal</a> dice</h6>\n          <p id=\"loading_text\">Loading libraries, please wait a bit...</p>\n          <p id=\"info_text\"><a href=\"http://www.teall.info/2014/01/online-3d-dice-roller.html\">More info and help</a></p>\n          <p id=\"info_text\"><a href=\"/mdice\">Multiplayer version</a></p>\n      </div>\n      <div id=\"info_div\" style={{display: \"none\"}}>\n          <div className=\"center_field\">\n              <span id=\"label\"></span>\n          </div>\n          <div className=\"center_field\">\n              <div className=\"bottom_field\">\n                  <span id=\"labelhelp\">click to continue or tap and drag again</span>\n              </div>\n          </div>\n      </div>\n      <div id=\"selector_div\" style={{display: \"none\"}}>\n          <div className=\"center_field\">\n              <div id=\"sethelp\">\n                  choose your dice set by clicking the dices or by direct input of notation,<br/>\n                  tap and drag on free space of screen or hit throw button to roll\n              </div>\n          </div>\n          <div className=\"center_field\">\n              <input type=\"text\" id=\"set\" value=\"4d6\" onChange={e => handleInput(e.target.value)} ></input><br/>\n              <button id=\"clear\">clear</button>\n              <button style={{marginLeft: \"0.6em\"}} id=\"throw\">throw</button>\n          </div>\n      </div>\n      <div id=\"canvas\"></div>  \n    </div>\n  )\n\n\n\n\n}\n\n\n\n\n\n\n\n\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}